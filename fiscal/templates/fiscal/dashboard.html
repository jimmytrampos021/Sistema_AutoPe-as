{% extends 'base.html' %}

{% block title %}Módulo Fiscal{% endblock %}
{% block page_title %}Módulo Fiscal{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        text-align: center;
        transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); }
    body.dark-mode .stat-card { background: #2d2d2d; }
    
    .stat-card h3 { font-size: 1.8rem; font-weight: 700; margin: 0; }
    .stat-card p { color: #718096; margin: 5px 0 0 0; font-size: 0.9rem; }
    
    .stat-card.verde h3 { color: #22c55e; }
    .stat-card.vermelho h3 { color: #ef4444; }
    .stat-card.azul h3 { color: #3b82f6; }
    .stat-card.amarelo h3 { color: #f59e0b; }
    .stat-card.roxo h3 { color: #8b5cf6; }
    
    .card-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-top: 20px;
    }
    body.dark-mode .card-section { background: #2d2d2d; }
    
    .quick-action {
        display: flex;
        align-items: center;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 10px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
    }
    .quick-action:hover { background: #e2e8f0; transform: translateX(5px); }
    body.dark-mode .quick-action { background: #1e1e1e; }
    body.dark-mode .quick-action:hover { background: #333; }
    
    .quick-action i { font-size: 1.5rem; margin-right: 15px; }
    .quick-action .text h6 { margin: 0; font-weight: 600; }
    .quick-action .text small { color: #718096; }
    
    .badge-autorizada { background: #22c55e; }
    .badge-rejeitada { background: #ef4444; }
    .badge-cancelada { background: #6b7280; }
    .badge-pendente { background: #f59e0b; }
    .badge-processando { background: #3b82f6; }
    
    .ambiente-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .ambiente-producao { background: #22c55e; color: white; }
    .ambiente-homologacao { background: #f59e0b; color: white; }
</style>
{% endblock %}

{% block content %}
<!-- Alertas -->
{% for alerta in alertas %}
<div class="alert alert-{{ alerta.tipo }} alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ alerta.mensagem }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}

<!-- Header com Status -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        {% if config %}
        <span class="ambiente-badge {% if config.ambiente == '1' %}ambiente-producao{% else %}ambiente-homologacao{% endif %}">
            {% if config.ambiente == '1' %}
            <i class="bi bi-check-circle me-1"></i> PRODUÇÃO
            {% else %}
            <i class="bi bi-tools me-1"></i> HOMOLOGAÇÃO
            {% endif %}
        </span>
        {% endif %}
    </div>
    <div>
        <a href="{% url 'fiscal:configuracao' %}" class="btn btn-outline-secondary">
            <i class="bi bi-gear"></i> Configurações
        </a>
    </div>
</div>

<!-- Estatísticas do Mês -->
<div class="row g-3 mb-4">
    <div class="col-md-2">
        <div class="stat-card azul">
            <h3>{{ stats.total_notas }}</h3>
            <p><i class="bi bi-file-text me-1"></i> Total Notas</p>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card verde">
            <h3>{{ stats.notas_autorizadas }}</h3>
            <p><i class="bi bi-check-circle me-1"></i> Autorizadas</p>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card vermelho">
            <h3>{{ stats.notas_rejeitadas }}</h3>
            <p><i class="bi bi-x-circle me-1"></i> Rejeitadas</p>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card amarelo">
            <h3>{{ stats.notas_canceladas }}</h3>
            <p><i class="bi bi-slash-circle me-1"></i> Canceladas</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card roxo">
            <h3>R$ {{ stats.valor_total|floatformat:2 }}</h3>
            <p><i class="bi bi-currency-dollar me-1"></i> Faturamento do Mês</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Ações Rápidas -->
    <div class="col-md-4">
        <div class="card-section">
            <h5 class="mb-3"><i class="bi bi-lightning me-2"></i>Ações Rápidas</h5>
            
            <a href="{% url 'fiscal:emitir_nfce' %}" class="quick-action">
                <i class="bi bi-receipt text-success"></i>
                <div class="text">
                    <h6>Emitir NFC-e</h6>
                    <small>Nota para consumidor final</small>
                </div>
            </a>
            
            <a href="{% url 'fiscal:emitir_nfe' %}" class="quick-action">
                <i class="bi bi-file-earmark-text text-primary"></i>
                <div class="text">
                    <h6>Emitir NF-e</h6>
                    <small>Nota para empresas</small>
                </div>
            </a>
            
            <a href="{% url 'fiscal:lista_notas' %}" class="quick-action">
                <i class="bi bi-list-ul text-info"></i>
                <div class="text">
                    <h6>Listar Notas</h6>
                    <small>Ver todas as notas emitidas</small>
                </div>
            </a>
            
            <a href="{% url 'fiscal:inutilizar' %}" class="quick-action">
                <i class="bi bi-x-square text-warning"></i>
                <div class="text">
                    <h6>Inutilizar Numeração</h6>
                    <small>Inutilizar números não usados</small>
                </div>
            </a>
        </div>
        
        <!-- Info Emissão -->
        <div class="card-section">
            <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Informações</h5>
            <div class="row text-center">
                <div class="col-6">
                    <h4 class="text-success mb-0">{{ stats.nfce_emitidas }}</h4>
                    <small class="text-muted">NFC-e este mês</small>
                </div>
                <div class="col-6">
                    <h4 class="text-primary mb-0">{{ stats.nfe_emitidas }}</h4>
                    <small class="text-muted">NF-e este mês</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Últimas Notas -->
    <div class="col-md-8">
        <div class="card-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Últimas Notas Emitidas</h5>
                <a href="{% url 'fiscal:lista_notas' %}" class="btn btn-sm btn-outline-primary">Ver Todas</a>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Modelo</th>
                            <th>Destinatário</th>
                            <th class="text-end">Valor</th>
                            <th class="text-center">Status</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nota in ultimas_notas %}
                        <tr style="cursor: pointer;" onclick="window.location='{% url 'fiscal:detalhe_nota' nota.pk %}'">
                            <td><strong>{{ nota.numero }}</strong></td>
                            <td>
                                {% if nota.modelo == '65' %}
                                <span class="badge bg-success">NFC-e</span>
                                {% else %}
                                <span class="badge bg-primary">NF-e</span>
                                {% endif %}
                            </td>
                            <td>{{ nota.dest_nome|default:"Consumidor"|truncatechars:30 }}</td>
                            <td class="text-end">R$ {{ nota.valor_total|floatformat:2 }}</td>
                            <td class="text-center">
                                {% if nota.status == 'AUTORIZADA' %}
                                <span class="badge badge-autorizada">Autorizada</span>
                                {% elif nota.status == 'REJEITADA' %}
                                <span class="badge badge-rejeitada">Rejeitada</span>
                                {% elif nota.status == 'CANCELADA' %}
                                <span class="badge badge-cancelada">Cancelada</span>
                                {% elif nota.status == 'PROCESSANDO' %}
                                <span class="badge badge-processando">Processando</span>
                                {% else %}
                                <span class="badge badge-pendente">Pendente</span>
                                {% endif %}
                            </td>
                            <td>{{ nota.data_emissao|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                Nenhuma nota emitida ainda
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
