{% extends 'base.html' %}

{% block title %}{% if editando %}Editar{% else %}Nova{% endif %} Categoria de Receita{% endblock %}

{% block page_title %}{% if editando %}Editar{% else %}Nova{% endif %} Categoria de Receita{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        background: #ffffff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
    }

    body.dark-mode .form-card {
        background: #2d2d2d;
        border-color: #404040;
    }

    .form-label {
        font-weight: 600;
        color: #4a5568;
    }

    body.dark-mode .form-label {
        color: #c0c0c0;
    }

    .form-control, .form-select {
        border-radius: 8px;
        padding: 12px 16px;
    }

    .btn-salvar {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 12px 30px;
        border-radius: 8px;
    }

    .btn-voltar {
        background: #6c757d;
        border: none;
        color: white;
        font-weight: 600;
        padding: 12px 30px;
        border-radius: 8px;
    }

    .preview-categoria {
        background: #f8fafc;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }

    body.dark-mode .preview-categoria {
        background: #363636;
    }

    .preview-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto 10px;
    }

    .icones-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        background: #f8fafc;
        border-radius: 8px;
    }

    body.dark-mode .icones-grid {
        background: #363636;
    }

    .icone-option {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

    .icone-option:hover {
        background: #e2e8f0;
    }

    .icone-option.selected {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="form-card">
                <form method="POST">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="form-label">Nome da Categoria</label>
                        <input type="text" name="nome" class="form-control" required
                               value="{% if editando %}{{ categoria.nome }}{% endif %}"
                               placeholder="Ex: Vendas de Peças">
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Tipo</label>
                        <select name="tipo" class="form-select" required>
                            <option value="VENDA" {% if editando and categoria.tipo == 'VENDA' %}selected{% endif %}>Venda</option>
                            <option value="SERVICO" {% if editando and categoria.tipo == 'SERVICO' %}selected{% endif %}>Serviço</option>
                            <option value="OUTROS" {% if editando and categoria.tipo == 'OUTROS' %}selected{% endif %}>Outros</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Cor</label>
                        <input type="color" name="cor" class="form-control form-control-color w-100" 
                               id="inputCor" value="{% if editando %}{{ categoria.cor }}{% else %}#22c55e{% endif %}"
                               onchange="atualizarPreview()">
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Ícone</label>
                        <input type="hidden" name="icone" id="inputIcone" value="{% if editando %}{{ categoria.icone }}{% else %}bi-cash{% endif %}">
                        <div class="icones-grid">
                            {% with icones="bi-cash,bi-cash-stack,bi-currency-dollar,bi-credit-card,bi-wallet,bi-receipt,bi-cart,bi-bag,bi-shop,bi-building,bi-truck,bi-tools,bi-wrench,bi-gear,bi-box,bi-archive,bi-clipboard,bi-file-text,bi-calculator,bi-graph-up,bi-bar-chart,bi-pie-chart,bi-percent,bi-tag,bi-tags,bi-star,bi-heart,bi-check-circle,bi-plus-circle,bi-arrow-up-circle,bi-person,bi-people" %}
                            {% for icone in icones.split %}
                            <div class="icone-option {% if editando and categoria.icone == icone %}selected{% endif %}" 
                                 data-icone="{{ icone }}" onclick="selecionarIcone('{{ icone }}', this)">
                                <i class="{{ icone }}"></i>
                            </div>
                            {% endfor %}
                            {% endwith %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Ordem de Exibição</label>
                        <input type="number" name="ordem" class="form-control" 
                               value="{% if editando %}{{ categoria.ordem }}{% else %}0{% endif %}"
                               min="0">
                    </div>

                    {% if editando %}
                    <div class="mb-4">
                        <div class="form-check">
                            <input type="checkbox" name="ativo" class="form-check-input" id="checkAtivo"
                                   {% if categoria.ativo %}checked{% endif %}>
                            <label class="form-check-label" for="checkAtivo">Categoria Ativa</label>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Preview -->
                    <div class="preview-categoria mb-4">
                        <div class="preview-icon" id="previewIcon" style="background: {% if editando %}{{ categoria.cor }}{% else %}#22c55e{% endif %}20; color: {% if editando %}{{ categoria.cor }}{% else %}#22c55e{% endif %};">
                            <i class="{% if editando %}{{ categoria.icone }}{% else %}bi-cash{% endif %}" id="previewIcone"></i>
                        </div>
                        <strong>Preview da Categoria</strong>
                    </div>

                    <div class="d-flex justify-content-end gap-3">
                        <a href="{% url 'financeiro:lista_categorias_receita' %}" class="btn btn-voltar">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-salvar">
                            <i class="bi bi-check-lg"></i> {% if editando %}Atualizar{% else %}Salvar{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selecionarIcone(icone, elemento) {
    document.querySelectorAll('.icone-option').forEach(el => el.classList.remove('selected'));
    elemento.classList.add('selected');
    document.getElementById('inputIcone').value = icone;
    document.getElementById('previewIcone').className = icone;
}

function atualizarPreview() {
    const cor = document.getElementById('inputCor').value;
    const previewIcon = document.getElementById('previewIcon');
    previewIcon.style.background = cor + '20';
    previewIcon.style.color = cor;
}
</script>
{% endblock %}