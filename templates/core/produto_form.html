{% extends 'base.html' %}
{% load l10n %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
{% block title %}{% if editando %}Editar{% else %}Novo{% endif %} Produto{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Mensagens de erro/sucesso -->
    {% if messages %}
    <div class="messages-container mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="bi bi-box-seam"></i>
                {% if editando %}Editar Produto{% else %}Cadastrar Novo Produto{% endif %}
            </h4>
        </div>
        <div class="card-body">

            <form method="post" enctype="multipart/form-data" id="produtoForm">
                {% csrf_token %}

                <!-- ABAS -->
                <ul class="nav nav-tabs mb-4" id="produtoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="identificacao-tab" data-bs-toggle="tab" 
                                data-bs-target="#identificacao" type="button">
                            <i class="bi bi-tag"></i> Identificação
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="localizacao-tab" data-bs-toggle="tab" 
                                data-bs-target="#localizacao" type="button">
                            <i class="bi bi-pin-map"></i> Localização
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="precos-tab" data-bs-toggle="tab" 
                                data-bs-target="#precos" type="button">
                            <i class="bi bi-cash-stack"></i> Preços
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="estoque-tab" data-bs-toggle="tab" 
                                data-bs-target="#estoque" type="button">
                            <i class="bi bi-boxes"></i> Estoque
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="veiculos-tab" data-bs-toggle="tab" 
                                data-bs-target="#veiculos" type="button">
                            <i class="bi bi-car-front"></i> Veículos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="outros-tab" data-bs-toggle="tab" 
                                data-bs-target="#outros" type="button">
                            <i class="bi bi-three-dots"></i> Outros
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="produtoTabContent">

                    <!-- ABA 1: IDENTIFICAÇÃO -->
                    <div class="tab-pane fade show active" id="identificacao" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-tag-fill"></i> Dados de Identificação
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Código Interno *</label>
                                        <input type="text" name="codigo" 
                                               class="form-control {% if form.codigo.errors %}is-invalid{% endif %}" 
                                               value="{{ form.codigo.value|default:'' }}" required>
                                        {% if form.codigo.errors %}
                                        <div class="invalid-feedback">{{ form.codigo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">SKU</label>
                                        <input type="text" name="codigo_sku" 
                                               class="form-control" 
                                               value="{{ form.codigo_sku.value|default:'' }}">
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Código de Barras</label>
                                        <input type="text" name="codigo_barras" 
                                               class="form-control" 
                                               value="{{ form.codigo_barras.value|default:'' }}">
                                    </div>
                                    
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Descrição *</label>
                                        <input type="text" name="descricao" 
                                               class="form-control {% if form.descricao.errors %}is-invalid{% endif %}" 
                                               value="{{ form.descricao.value|default:'' }}" required>
                                        {% if form.descricao.errors %}
                                        <div class="invalid-feedback">{{ form.descricao.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label class="form-label">Descrição Detalhada</label>
                                        <textarea name="descricao_detalhada" 
                                                  class="form-control" 
                                                  rows="3">{{ form.descricao_detalhada.value|default:'' }}</textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Categoria</label>
                                        <select name="categoria" id="id_categoria" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for cat in categorias %}
                                            <option value="{{ cat.id }}" 
                                                    {% if form.categoria.value|stringformat:"s" == cat.id|stringformat:"s" %}selected{% endif %}>
                                                {{ cat.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Subcategoria</label>
                                        <select name="subcategoria" id="id_subcategoria" class="form-select">
                                            <option value="">Selecione a categoria primeiro...</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Grupo</label>
                                        <select name="grupo" id="id_grupo" class="form-select">
                                            <option value="">Selecione a subcategoria primeiro...</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Subgrupo</label>
                                        <select name="subgrupo" id="id_subgrupo" class="form-select">
                                            <option value="">Selecione o grupo primeiro...</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Fabricante</label>
                                        <select name="fabricante" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for fab in form.fields.fabricante.queryset %}
                                            <option value="{{ fab.id }}" 
                                                    {% if form.fabricante.value|stringformat:"s" == fab.id|stringformat:"s" %}selected{% endif %}>
                                                {{ fab.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                            <div class="col-md-6">
                                <label class="form-label">Referência Fabricante</label>
                                <input type="text" name="referencia_fabricante" 
                                    class="form-control" 
                                    value="{{ form.referencia_fabricante.value|default:'' }}"
                                    placeholder="Código original do fabricante">
                            </div>

                            <!-- CAMPO DE BATERIA - AMPERAGEM -->
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="bi bi-battery-charging text-warning"></i> Amperagem (Bateria)
                                </label>
                                <select name="amperagem_bateria" id="id_amperagem_bateria" class="form-select">
                                    <option value="">Não é bateria</option>
                                    {% for amp in amperagens %}
                                    <option value="{{ amp.id }}" 
                                            {% if form.amperagem_bateria.value|stringformat:"s" == amp.id|stringformat:"s" %}selected{% endif %}
                                            data-valor-casco="{{ amp.valor_casco_troca }}">
                                        {{ amp.amperagem }} {% if amp.nome_tecnico %}({{ amp.nome_tecnico }}){% endif %} - Casco: R$ {{ amp.valor_casco_troca }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Selecione apenas se o produto for uma bateria</small>
                            </div>
                            
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 2: LOCALIZAÇÃO -->
                    <div class="tab-pane fade" id="localizacao" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-pin-map-fill"></i> Localização no Estoque
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Loja</label>
                                        <input type="text" name="loja" 
                                               class="form-control" 
                                               value="{{ form.loja.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Setor</label>
                                        <input type="text" name="setor" 
                                               class="form-control" 
                                               value="{{ form.setor.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Prateleira</label>
                                        <input type="text" name="prateleira" 
                                               class="form-control" 
                                               value="{{ form.prateleira.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Divisão</label>
                                        <input type="text" name="divisao_prateleira" 
                                               class="form-control" 
                                               value="{{ form.divisao_prateleira.value|default:'' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 3: PREÇOS - VERSÃO FINAL CORRIGIDA -->
                    <div class="tab-pane fade" id="precos" role="tabpanel">
                        
                        <!-- PREÇOS BASE -->
                        <div class="card mb-4 preco-card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-cash-stack"></i> Preços Base
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-tag-fill text-danger"></i> Preço de Custo *
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_custo" 
                                                id="preco_custo"
                                                class="form-control form-control-lg" 
                                                value="{% if form.preco_custo.value %}{{ form.preco_custo.value|unlocalize }}{% else %}0.00{% endif %}">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-cash-coin text-success"></i> Preço à Vista (Dinheiro/PIX) *
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_venda_dinheiro"
                                                id="preco_venda_dinheiro"
                                                class="form-control form-control-lg"
                                                value="{% if form.preco_venda_dinheiro.value %}{{ form.preco_venda_dinheiro.value|unlocalize }}{% else %}0.00{% endif %}">
                                        </div>
                                        <div id="margem-lucro-info" class="mt-2"></div>
                                    </div>
                                </div>

                                <!-- BOTÃO CALCULAR TODOS -->
                                <div class="alert alert-calcular mt-4">
                                    <div class="d-flex align-items-center justify-content-between flex-wrap">
                                        <div class="flex-grow-1 mb-2 mb-md-0">
                                            <h5 class="mb-1">
                                                <i class="bi bi-magic"></i> Cálculo Automático de Preços
                                            </h5>
                                            <p class="mb-0 texto-calcular">
                                                Preencha o preço à vista e clique no botão para calcular automaticamente todos os preços de cartão!
                                            </p>
                                        </div>
                                        <button type="button" id="btn-calcular-todos-precos" class="btn btn-light btn-lg">
                                            <i class="bi bi-lightning-charge-fill"></i> Calcular Tudo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PREÇOS CALCULADOS AUTOMATICAMENTE -->
                        <div class="card mb-4 preco-card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-credit-card"></i> Preços de Cartão (Calculados Automaticamente)
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="bi bi-credit-card text-primary"></i> Débito
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_venda_debito"
                                                id="preco_venda_debito"
                                                class="form-control"
                                                value="{% if editando and produto.preco_venda_debito %}{{ produto.preco_venda_debito|unlocalize }}{% else %}0.00{% endif %}" readonly>
                                        </div>
                                        <small class="text-muted taxa-label">Taxa: 1,09%</small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="bi bi-credit-card-2-front text-info"></i> Crédito à Vista
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_venda_credito" 
                                                id="preco_venda_credito"
                                                class="form-control" 
                                                value="{% if editando and produto.preco_venda_credito %}{{ produto.preco_venda_credito|unlocalize }}{% else %}0.00{% endif %}" readonly>
                                        </div>
                                        <small class="text-muted taxa-label">Taxa: 3,45%</small>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="bi bi-gift text-warning"></i> Preço Promocional
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_promocional" 
                                                class="form-control" 
                                                value="{% if editando and produto.preco_promocional %}{{ produto.preco_promocional }}{% else %}0.00{% endif %}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CONFIGURAÇÕES DE IMPOSTOS E CUSTOMIZAÇÃO -->
                        <div class="card mb-4 preco-card" id="card-config-avancada">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-gear-fill"></i> Configurações Avançadas
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch" style="padding-left: 3rem;">
                                            <input class="form-check-input" type="checkbox" 
                                                name="aplicar_imposto_4" 
                                                id="aplicar_imposto_4"
                                                {% if editando and produto.aplicar_imposto_4 %}checked{% endif %}
                                                style="width: 3rem; height: 1.5rem; cursor: pointer;">
                                            <label class="form-check-label fw-bold label-config" for="aplicar_imposto_4" style="margin-left: 1rem; cursor: pointer;">
                                                <i class="bi bi-percent text-danger"></i> Aplicar Imposto de 4% (Simples Nacional)
                                            </label>
                                        </div>
                                        <small class="text-muted taxa-label d-block mt-2 ms-5">
                                            Quando ativo, 4% será adicionado automaticamente em todos os preços de venda
                                        </small>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-check form-switch" style="padding-left: 3rem;">
                                            <input class="form-check-input" type="checkbox" 
                                                name="preco_customizado_cartao" 
                                                id="preco_customizado_cartao"
                                                {% if editando and produto.preco_customizado_cartao %}checked{% endif %}
                                                style="width: 3rem; height: 1.5rem; cursor: pointer;">
                                            <label class="form-check-label fw-bold label-config" for="preco_customizado_cartao" style="margin-left: 1rem; cursor: pointer;">
                                                <i class="bi bi-pencil-square text-primary"></i> Definir Preços Customizados por Parcela
                                            </label>
                                        </div>
                                        <small class="text-muted taxa-label d-block mt-2 ms-5">
                                            Permite definir manualmente o preço para cada quantidade de parcelas
                                        </small>
                                    </div>
                                </div>

                                <div id="aviso-imposto-4" style="{% if editando and produto.aplicar_imposto_4 %}display: block;{% else %}display: none;{% endif %}" class="alert alert-danger mt-3 mb-0">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                    <strong>ATENÇÃO:</strong> Imposto de 4% está ATIVO! Todos os preços finais incluirão este valor.
                                </div>
                            </div>
                        </div>

                        <!-- PREÇOS CUSTOMIZADOS POR PARCELA -->
                        <div class="card mb-4 preco-card" id="card-precos-customizados" style="{% if editando and produto.preco_customizado_cartao %}display: block;{% else %}display: none;{% endif %}">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-credit-card-2-back-fill"></i> Preços Customizados - Crédito Parcelado
                                </h5>
                                
                                <div class="alert alert-warning alerta-custom">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <strong>Como funciona:</strong> Defina manualmente o preço para cada parcelamento. 
                                    Deixe em branco para usar o cálculo automático com as taxas padrão.
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 2x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_2x" id="preco_credito_2x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_2x %}{{ produto.preco_credito_2x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-2"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 3x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_3x" id="preco_credito_3x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_3x %}{{ produto.preco_credito_3x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-3"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 4x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_4x" id="preco_credito_4x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_4x %}{{ produto.preco_credito_4x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-4"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 5x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_5x" id="preco_credito_5x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_5x %}{{ produto.preco_credito_5x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-5"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 6x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_6x" id="preco_credito_6x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_6x %}{{ produto.preco_credito_6x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-6"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 7x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_7x" id="preco_credito_7x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_7x %}{{ produto.preco_credito_7x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-7"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 8x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_8x" id="preco_credito_8x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_8x %}{{ produto.preco_credito_8x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-8"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 9x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_9x" id="preco_credito_9x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_9x %}{{ produto.preco_credito_9x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-9"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 10x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_10x" id="preco_credito_10x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_10x %}{{ produto.preco_credito_10x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-10"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 11x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_11x" id="preco_credito_11x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_11x %}{{ produto.preco_credito_11x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-11"></small>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold"><i class="bi bi-credit-card"></i> 12x no Cartão</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_credito_12x" id="preco_credito_12x"
                                                class="form-control preco-customizado" 
                                                value="{% if editando and produto.preco_credito_12x %}{{ produto.preco_credito_12x }}{% endif %}"
                                                placeholder="Automático">
                                        </div>
                                        <small class="text-muted taxa-label taxa-info-12"></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PREÇOS DE ATACADO -->
                        <div class="card mb-4 preco-card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-box-seam-fill"></i> Atacado
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="bi bi-boxes"></i> Preço Atacado
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" step="0.01" name="preco_atacado" 
                                                class="form-control" 
                                                value="{% if editando and produto.preco_atacado %}{{ produto.preco_atacado }}{% else %}0.00{% endif %}">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="bi bi-123"></i> Quantidade Mínima para Atacado
                                        </label>
                                        <input type="number" name="quantidade_minima_atacado" 
                                            class="form-control" 
                                            value="{% if editando and produto.quantidade_minima_atacado %}{{ produto.quantidade_minima_atacado }}{% else %}10{% endif %}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PREVIEW DE TODOS OS PREÇOS -->
                        <div class="card preco-card preview-card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-eye-fill"></i> Visualização de Todos os Preços
                                </h5>
                                
                                <div id="preview-precos-container" class="preview-container">
                                    <p class="text-center py-4 preview-placeholder">
                                        <i class="bi bi-info-circle" style="font-size: 2rem;"></i><br>
                                        Preencha o preço à vista e clique em "Calcular Tudo" para ver o preview completo
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>
<!-- CSS PARA MODO ESCURO -->
<style>
/* Cards de preços */
.preco-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s;
}

/* Modo Escuro */
body.dark-mode .preco-card {
    background: #2d2d2d;
    border-color: #444;
    color: #e0e0e0;
}

body.dark-mode .preco-card .card-title {
    color: #e0e0e0;
}

body.dark-mode .form-control,
body.dark-mode .input-group-text {
    background-color: #1a1a1a;
    border-color: #444;
    color: #e0e0e0;
}

body.dark-mode .form-control:focus {
    background-color: #1a1a1a;
    border-color: #667eea;
    color: #e0e0e0;
}

body.dark-mode .form-control::placeholder {
    color: #777;
}

body.dark-mode .form-control[readonly] {
    background-color: #333;
    color: #999;
}

body.dark-mode .text-muted {
    color: #aaa !important;
}

body.dark-mode .label-config {
    color: #e0e0e0;
}

body.dark-mode .alert-calcular {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
}

body.dark-mode .texto-calcular {
    color: rgba(255, 255, 255, 0.9);
}

body.dark-mode .alert-warning {
    background-color: #664d03;
    border-color: #997404;
    color: #ffecb5;
}

body.dark-mode .alert-danger {
    background-color: #58151c;
    border-color: #842029;
    color: #f1aeb5;
}

body.dark-mode .table {
    color: #e0e0e0;
}

body.dark-mode .table-dark {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

body.dark-mode .table-hover tbody tr:hover {
    background-color: #3a3a3a;
}

body.dark-mode .table-bordered,
body.dark-mode .table-bordered th,
body.dark-mode .table-bordered td {
    border-color: #444;
}

body.dark-mode #preview-precos-container {
    background-color: #1a1a1a;
}

body.dark-mode #card-config-avancada {
    border-color: #444;
}

/* Botão Calcular Tudo */
.alert-calcular {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
}

.texto-calcular {
    font-size: 0.9rem;
}

.form-control-lg {
    font-size: 1.25rem;
    font-weight: 600;
}

.input-group-text {
    font-weight: 600;
}

.preco-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

body.dark-mode .preco-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

#btn-calcular-todos-precos {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>

                    <!-- ABA 4: ESTOQUE -->
                    <div class="tab-pane fade" id="estoque" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-boxes"></i> Gerenciamento de Estoque
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Estoque Atual</label>
                                        <input type="number" step="0.01" name="estoque_atual" 
                                               class="form-control" 
                                               value="{{ form.estoque_atual.value|default:'0' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Estoque Mínimo</label>
                                        <input type="number" step="0.01" name="estoque_minimo" 
                                               class="form-control" 
                                               value="{{ form.estoque_minimo.value|default:'0' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Estoque Máximo</label>
                                        <input type="number" step="0.01" name="estoque_maximo" 
                                               class="form-control" 
                                               value="{{ form.estoque_maximo.value|default:'0' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 5: VEÍCULOS -->
                    <div class="tab-pane fade" id="veiculos" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-car-front"></i> Veículos Compatíveis (Múltiplos)
                                </h5>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">1. Montadora</label>
                                        <select id="select-montadora" class="form-select">
                                            <option value="">Escolha...</option>
                                            {% for m in montadoras %}
                                            <option value="{{ m.id }}">{{ m.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">2. Modelo</label>
                                        <select id="select-modelo" class="form-select" disabled>
                                            <option>Selecione a montadora...</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="versoes-container" class="mb-3"></div>

                                <button type="button" id="btn-adicionar-modelo" 
                                        class="btn btn-success" disabled>
                                    <i class="bi bi-plus-circle"></i> Adicionar Versões Selecionadas
                                </button>

                                <div class="mt-4">
                                    <h6><i class="bi bi-check-circle"></i> Versões Adicionadas:</h6>
                                    <div id="lista-modelos-selecionados" class="modelos-lista">
                                        {% if editando and produto.versoes_compativeis.exists %}
                                            {% for v in produto.versoes_compativeis.all %}
                                            <div class="modelo-badge" data-versao-id="{{ v.id }}">
                                                <span>
                                                    <i class="bi bi-car-front-fill"></i>
                                                    {{ v.modelo.montadora.nome }} {{ v.modelo.nome }} 
                                                    <strong>{{ v.nome }}</strong> ({{ v.get_anos_range }})
                                                </span>
                                                <input type="hidden" name="versoes_compativeis" value="{{ v.id }}">
                                                <button type="button" class="btn-remover" 
                                                        onclick="removerVersao({{ v.id }})">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted" id="msg-sem-modelos">
                                                Nenhuma versão adicionada...
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 6: OUTROS -->
                    <div class="tab-pane fade" id="outros" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-three-dots"></i> Informações Adicionais
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Peso (kg)</label>
                                        <input type="number" step="0.001" name="peso" 
                                               class="form-control" 
                                               value="{{ form.peso.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Altura (cm)</label>
                                        <input type="number" step="0.01" name="altura" 
                                               class="form-control" 
                                               value="{{ form.altura.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Largura (cm)</label>
                                        <input type="number" step="0.01" name="largura" 
                                               class="form-control" 
                                               value="{{ form.largura.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Comprimento (cm)</label>
                                        <input type="number" step="0.01" name="comprimento" 
                                               class="form-control" 
                                               value="{{ form.comprimento.value|default:'' }}">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">NCM</label>
                                        <input type="text" name="ncm" 
                                               class="form-control" 
                                               value="{{ form.ncm.value|default:'' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Unidade</label>
                                        <input type="text" name="unidade_medida" 
                                               class="form-control" 
                                               value="{{ form.unidade_medida.value|default:'UN' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Garantia (meses)</label>
                                        <input type="number" name="garantia_meses" 
                                               class="form-control" 
                                               value="{{ form.garantia_meses.value|default:'0' }}">
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="ativo" id="ativo"
                                                   {% if not editando or form.ativo.value %}checked{% endif %}>
                                            <label class="form-check-label" for="ativo">
                                                Produto Ativo
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="destaque" id="destaque"
                                                   {% if form.destaque.value %}checked{% endif %}>
                                            <label class="form-check-label" for="destaque">
                                                Produto em Destaque
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <label class="form-label">Imagem do Produto</label>
                                        <input type="file" name="imagem" 
                                               class="form-control" 
                                               accept="image/*">
                                        {% if editando and produto.imagem %}
                                        <small class="text-muted">Imagem atual: {{ produto.imagem.name }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- tab-content -->

                <!-- BOTÕES -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'lista_estoque' %}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                    <button class="btn btn-success btn-lg" type="submit">
                        <i class="bi bi-check-circle"></i> 
                        {% if editando %}Atualizar Produto{% else %}Cadastrar Produto{% endif %}
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- CSS MODO ESCURO MELHORADO -->
<style>
/* ========== MODO CLARO (PADRÃO) ========== */
.preco-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s;
    border: 1px solid #e9ecef;
}

.preco-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.preview-card {
    border: 3px solid #667eea !important;
}

.alert-calcular {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
}

.texto-calcular {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.95);
}

.form-control-lg {
    font-size: 1.25rem;
    font-weight: 600;
}

.badge.bg-purple {
    background-color: #6f42c1 !important;
}

#btn-calcular-todos-precos {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.alerta-custom {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
}

.preview-placeholder {
    color: #6c757d;
}

/* ========== MODO ESCURO ========== */
body.dark-mode .preco-card {
    background: #2d2d2d;
    border-color: #444;
    color: #e0e0e0;
}

body.dark-mode .preco-card .card-title {
    color: #e0e0e0;
}

body.dark-mode .form-label {
    color: #e0e0e0;
}

body.dark-mode .form-control,
body.dark-mode .input-group-text,
body.dark-mode .form-select {
    background-color: #1a1a1a;
    border-color: #444;
    color: #e0e0e0;
}

body.dark-mode .form-control:focus,
body.dark-mode .form-select:focus {
    background-color: #1a1a1a;
    border-color: #667eea;
    color: #e0e0e0;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

body.dark-mode .form-control::placeholder {
    color: #777;
}

body.dark-mode .form-control[readonly] {
    background-color: #333;
    color: #999;
}

body.dark-mode .taxa-label,
body.dark-mode small.text-muted {
    color: #aaa !important;
}

body.dark-mode .label-config {
    color: #e0e0e0;
}

body.dark-mode .alert-calcular {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

body.dark-mode .alerta-custom {
    background-color: #664d03;
    border-color: #997404;
    color: #ffecb5;
}

body.dark-mode .alert-danger {
    background-color: #58151c;
    border-color: #842029;
    color: #f1aeb5;
}

body.dark-mode .alert-success {
    background-color: #0f5132;
    border-color: #198754;
    color: #d1e7dd;
}

body.dark-mode .table {
    color: #e0e0e0;
    background-color: #1a1a1a;
}

body.dark-mode .table-dark {
    background-color: #000;
    color: #e0e0e0;
    border-color: #444;
}

body.dark-mode .table-dark th,
body.dark-mode .table-dark td {
    border-color: #444;
}

body.dark-mode .table-hover tbody tr:hover {
    background-color: #3a3a3a;
}

body.dark-mode .table-bordered,
body.dark-mode .table-bordered th,
body.dark-mode .table-bordered td {
    border-color: #444;
}

body.dark-mode .preview-container {
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 10px;
}

body.dark-mode .preview-placeholder {
    color: #aaa;
}

body.dark-mode #card-config-avancada {
    border-color: #444;
}

body.dark-mode .preview-card {
    border-color: #667eea !important;
}

body.dark-mode .badge {
    color: #fff;
}

body.dark-mode .btn-light {
    background-color: #f8f9fa;
    color: #212529;
}

body.dark-mode .btn-light:hover {
    background-color: #e2e6ea;
}
</style>




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {

    // Carregar modelos ao selecionar montadora
    $('#select-montadora').change(function() {
        const montadoraId = $(this).val();
        const modeloSelect = $('#select-modelo');
        const versoesContainer = $('#versoes-container');

        modeloSelect.html('<option value="">Carregando...</option>').prop('disabled', true);
        versoesContainer.html('');
        $('#btn-adicionar-modelo').prop('disabled', true);

        if (!montadoraId) {
            modeloSelect.html('<option value="">Selecione a montadora primeiro</option>');
            return;
        }

        $.get('/api/modelos/?montadora_id=' + montadoraId, function(data) {
            if (data.success && data.modelos.length > 0) {
                let html = '<option value="">Selecione o modelo...</option>';
                data.modelos.forEach(modelo => {
                    html += `<option value="${modelo.id}">${modelo.nome} (${modelo.total_versoes} versões)</option>`;
                });
                modeloSelect.html(html).prop('disabled', false);
            } else {
                modeloSelect.html('<option value="">Nenhum modelo encontrado</option>');
            }
        }).fail(function() {
            alert('Erro ao carregar modelos. Verifique a URL /api/modelos/');
        });
    });

    // Carregar versões ao selecionar modelo
    $('#select-modelo').change(function() {
        const modeloId = $(this).val();
        const versoesContainer = $('#versoes-container');

        versoesContainer.html('');
        $('#btn-adicionar-modelo').prop('disabled', true);

        if (!modeloId) {
            return;
        }

        $.get('/api/versoes/?modelo_id=' + modeloId, function(data) {
            if (data.success && data.versoes.length > 0) {

                let html = '<div class="versoes-checklist">';
                html += '<h6><i class="bi bi-check-square"></i> 3. Marque as versões compatíveis:</h6>';
                html += `
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="toggle-all">
                            <i class="bi bi-check-all"></i> Marcar/Desmarcar Todas
                        </button>
                    </div>
                `;

                data.versoes.forEach(versao => {
                    html += `
                        <div class="form-check">
                            <input class="form-check-input versao-checkbox" type="checkbox" 
                                value="${versao.id}" 
                                id="versao_${versao.id}"
                                data-montadora="${$('#select-montadora option:selected').text()}"
                                data-modelo="${$('#select-modelo option:selected').text()}"
                                data-versao="${versao.nome}"
                                data-anos="${versao.anos_range}"
                                data-motores="${versao.motorizacoes}">
                            <label class="form-check-label" for="versao_${versao.id}">
                                <strong>${versao.nome}</strong> (${versao.anos_range}) - ${versao.motorizacoes}
                            </label>
                        </div>
                    `;
                });

                html += '</div>';

                versoesContainer.html(html);
                $('#btn-adicionar-modelo').prop('disabled', false);

                // Toggle all checkboxes
                $('#toggle-all').click(function() {
                    const checkboxes = $('.versao-checkbox');
                    const allChecked = checkboxes.filter(':checked').length === checkboxes.length;
                    checkboxes.prop('checked', !allChecked);
                });
            }
        }).fail(function() {
            alert('Erro ao carregar versões. Verifique a URL /api/versoes/');
        });
    });

    // Adicionar versões selecionadas
    $('#btn-adicionar-modelo').click(function() {
        const checkedBoxes = $('.versao-checkbox:checked');

        if (checkedBoxes.length === 0) {
            alert('Selecione pelo menos uma versão!');
            return;
        }

        const lista = $('#lista-modelos-selecionados');
        $('#msg-sem-modelos').remove();

        let count = 0;
        checkedBoxes.each(function() {
            const c = $(this);
            const id = c.val();

            // Verificar se já foi adicionado
            if ($(`[data-versao-id="${id}"]`).length > 0) {
                return;
            }

            const html = `
                <div class="modelo-badge" data-versao-id="${id}">
                    <span>
                        <i class="bi bi-car-front-fill"></i>
                        ${c.data('montadora')} ${c.data('modelo')} 
                        <strong>${c.data('versao')}</strong> (${c.data('anos')})
                    </span>
                    <input type="hidden" name="versoes_compativeis" value="${id}">
                    <button type="button" class="btn-remover" onclick="removerVersao(${id})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;

            lista.append(html);
            count++;
        });

        // Limpar seleção
        $('#select-montadora').val('');
        $('#select-modelo').html('<option value="">Selecione a montadora primeiro</option>').prop('disabled', true);
        $('#versoes-container').html('');
        $('#btn-adicionar-modelo').prop('disabled', true);

        // Feedback
        alert(`✅ ${count} versão(ões) adicionada(s) com sucesso!`);
    });
});

// Função global para remover versão
function removerVersao(id) {
    if (confirm('Remover esta versão do produto?')) {
        $(`[data-versao-id="${id}"]`).remove();

        // Se não sobrou nenhuma, mostrar mensagem
        if ($('.modelo-badge').length === 0) {
            $('#lista-modelos-selecionados').html(
                '<p class="text-muted" id="msg-sem-modelos">Nenhuma versão adicionada...</p>'
            );
        }
    }
}


// ==========================================
// SISTEMA DE PREÇOS - JAVASCRIPT CORRIGIDO
// ==========================================

$(document).ready(function() {
    
    console.log('🚀 Sistema de preços customizados iniciado!');
    
    // TABELA DE TAXAS
    const TAXAS = {
        'DEBITO': 1.09,
        'CREDITO': {
            1: 3.45, 2: 5.18, 3: 6.37, 4: 7.56, 5: 8.75, 6: 9.94,
            7: 11.13, 8: 12.32, 9: 13.51, 10: 14.70, 11: 15.89, 12: 17.08
        }
    };
    
    // FUNÇÕES DE CÁLCULO
    function calcularPrecoComTaxa(precoBase, taxaPercentual) {
        if (!precoBase || precoBase <= 0) return 0;
        // Calcula o preço que, após descontar a taxa, resulta no precoBase
        return precoBase / (1 - (taxaPercentual / 100));      
    }
    
    function aplicarImposto4(preco) {
        const imposto4Ativo = $('#aplicar_imposto_4').is(':checked');
        if (imposto4Ativo && preco > 0) {
            return preco * 1.04;
        }
        return preco;
    }
    
    // VALIDAÇÃO DE MARGEM DE LUCRO - CORRIGIDA!
    function validarMargem() {
        const precoCusto = parseFloat($('#preco_custo').val()) || 0;
        const precoVenda = parseFloat($('#preco_venda_dinheiro').val()) || 0;
        const container = $('#margem-lucro-info');
        
        container.html('');
        
        if (precoCusto > 0 && precoVenda > 0) {
            if (precoCusto >= precoVenda) {
                container.html(`
                    <div class="alert alert-danger py-2 mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>PREJUÍZO!</strong> Preço de venda menor ou igual ao custo.
                    </div>
                `);
            } else {
                const lucro = precoVenda - precoCusto;
                
                // MARGEM: (Lucro / Custo) * 100
                const markup = ((lucro / precoCusto) * 100).toFixed(2);
                
                // MARKUP: (Lucro / Preço Venda) * 100
                const margem = ((lucro / precoVenda) * 100).toFixed(2);
                
                container.html(`
                    <div class="alert alert-success py-2 mb-0">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>Lucro:</strong> R$ ${lucro.toFixed(2)} | 
                        <strong>Margem:</strong> ${margem}% | 
                        <strong>Markup:</strong> ${markup}%
                    </div>
                `);
            }
        }
    }
    
    // CALCULAR TODOS OS PREÇOS
    $('#btn-calcular-todos-precos').click(function() {
        console.log('🔄 Calculando todos os preços...');
        
        const precoVista = parseFloat($('#preco_venda_dinheiro').val()) || 0;
        
        if (precoVista <= 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Preço à Vista Não Definido',
                text: 'Por favor, defina o preço à vista primeiro!',
                confirmButtonColor: '#667eea'
            });
            $('#preco_venda_dinheiro').focus();
            return;
        }
        
        // Calcula Débito
        let precoDebito = calcularPrecoComTaxa(precoVista, TAXAS.DEBITO);
        precoDebito = aplicarImposto4(precoDebito);
        $('#preco_venda_debito').val(precoDebito.toFixed(2));
        
        // Calcula Crédito à Vista
        let precoCredito1x = calcularPrecoComTaxa(precoVista, TAXAS.CREDITO[1]);
        precoCredito1x = aplicarImposto4(precoCredito1x);
        $('#preco_venda_credito').val(precoCredito1x.toFixed(2));
        
        // Se preços customizados estiver ativo, preenche as parcelas
        if ($('#preco_customizado_cartao').is(':checked')) {
            for (let parcela = 2; parcela <= 12; parcela++) {
                let precoParcelado = calcularPrecoComTaxa(precoVista, TAXAS.CREDITO[parcela]);
                precoParcelado = aplicarImposto4(precoParcelado);
                $(`#preco_credito_${parcela}x`).val(precoParcelado.toFixed(2));
            }
        }
        
        // Atualiza preview
        atualizarPreview();
        
        // Mensagem de sucesso
        Swal.fire({
            icon: 'success',
            title: 'Preços Calculados!',
            text: 'Todos os preços foram calculados automaticamente.',
            timer: 2000,
            showConfirmButton: false
        });
        
        console.log('✅ Cálculo concluído!');
    });
    
    // ATUALIZAR PREVIEW DE PREÇOS
    function atualizarPreview() {
        const precoVista = parseFloat($('#preco_venda_dinheiro').val()) || 0;
        const precoCusto = parseFloat($('#preco_custo').val()) || 0;
        const imposto4Ativo = $('#aplicar_imposto_4').is(':checked');
        const customizado = $('#preco_customizado_cartao').is(':checked');
        
        if (precoVista <= 0) {
            $('#preview-precos-container').html(`
                <p class="text-center py-4 preview-placeholder">
                    <i class="bi bi-info-circle" style="font-size: 2rem;"></i><br>
                    Preencha o preço à vista para ver o preview
                </p>
            `);
            return;
        }
        
        let html = '<div class="table-responsive">';
        html += '<table class="table table-hover table-bordered">';
        html += '<thead class="table-dark">';
        html += '<tr>';
        html += '<th>Forma de Pagamento</th>';
        html += '<th class="text-end">Preço Final</th>';
        html += '<th class="text-center">Tipo</th>';
        if (precoCusto > 0) {
            html += '<th class="text-end">Lucro Líquido</th>';
            html += '<th class="text-end">Margem</th>';
        }
        html += '</tr>';
        html += '</thead><tbody>';
        
        // PIX/Dinheiro
        const precoVenda = parseFloat($('#preco_venda_dinheiro').val()) || 0;
        let precoPix = precoVista;
        if (imposto4Ativo) precoPix = precoPix * 1.04;
        let lucroPix = precoPix - precoCusto;
        let margemPix = precoPix > 0 ? ((lucroPix / precoPix) * 100).toFixed(1) : 0;
        
        html += '<tr>';
        html += '<td><i class="bi bi-cash-coin text-success"></i> <strong>PIX / Dinheiro</strong></td>';
        html += `<td class="text-end fw-bold text-success">R$ ${precoPix.toFixed(2)}</td>`;
        html += '<td class="text-center"><span class="badge bg-success">Sem Taxa</span></td>';
        if (precoCusto > 0) {
            html += `<td class="text-end">R$ ${lucroPix.toFixed(2)}</td>`;
            html += `<td class="text-end">${margemPix}%</td>`;
        }
        html += '</tr>';
        
        // Débito
        let precoDebito = parseFloat($('#preco_venda_debito').val()) || 0;
        let taxaDebito = precoDebito * 0.0109;
        let lucroDebito = precoDebito - precoCusto - taxaDebito;
        let margemDebito = precoDebito > 0 ? ((lucroDebito / precoDebito) * 100).toFixed(1) : 0;
        
        html += '<tr>';
        html += '<td><i class="bi bi-credit-card text-primary"></i> Débito</td>';
        html += `<td class="text-end fw-bold text-primary">R$ ${precoDebito.toFixed(2)}</td>`;
        html += '<td class="text-center"><span class="badge bg-primary">Auto</span></td>';
        if (precoCusto > 0) {
            html += `<td class="text-end">R$ ${lucroDebito.toFixed(2)}</td>`;
            html += `<td class="text-end">${margemDebito}%</td>`;
        }
        html += '</tr>';
        
        // Crédito 1x
        let precoCredito1x = parseFloat($('#preco_venda_credito').val()) || 0;
        let taxaCredito1x = precoCredito1x * 0.0345;
        let lucroCredito1x = precoCredito1x - precoCusto - taxaCredito1x;
        let margemCredito1x = precoCredito1x > 0 ? ((lucroCredito1x / precoCredito1x) * 100).toFixed(1) : 0;
        
        html += '<tr>';
        html += '<td><i class="bi bi-credit-card-2-front text-info"></i> Crédito à Vista</td>';
        html += `<td class="text-end fw-bold text-info">R$ ${precoCredito1x.toFixed(2)}</td>`;
        html += '<td class="text-center"><span class="badge bg-info">Auto</span></td>';
        if (precoCusto > 0) {
            html += `<td class="text-end">R$ ${lucroCredito1x.toFixed(2)}</td>`;
            html += `<td class="text-end">${margemCredito1x}%</td>`;
        }
        html += '</tr>';
        
        // Crédito Parcelado (2x a 12x)
        for (let parcela = 2; parcela <= 12; parcela++) {
            let precoParcelado;
            let tipoCalculo;
            let badgeColor;
            
            const campoCustom = $(`#preco_credito_${parcela}x`).val();
            
            if (customizado && campoCustom && parseFloat(campoCustom) > 0) {
                precoParcelado = parseFloat(campoCustom);
                tipoCalculo = 'Custom';
                badgeColor = 'purple';
            } else {
                precoParcelado = calcularPrecoComTaxa(precoVista, TAXAS.CREDITO[parcela]);
                precoParcelado = aplicarImposto4(precoParcelado);
                tipoCalculo = 'Auto';
                badgeColor = 'secondary';
            }
            
            const taxaParcela = precoParcelado * (TAXAS.CREDITO[parcela] / 100);
            const lucroParcela = precoParcelado - precoCusto - taxaParcela;
            const margemParcela = precoParcelado > 0 ? ((lucroParcela / precoParcelado) * 100).toFixed(1) : 0;
            
            html += '<tr>';
            html += `<td><i class="bi bi-credit-card-2-back"></i> Crédito ${parcela}x</td>`;
            html += `<td class="text-end fw-bold">R$ ${precoParcelado.toFixed(2)}</td>`;
            html += `<td class="text-center"><span class="badge bg-${badgeColor}">${tipoCalculo}</span></td>`;
            if (precoCusto > 0) {
                html += `<td class="text-end">R$ ${lucroParcela.toFixed(2)}</td>`;
                html += `<td class="text-end">${margemParcela}%</td>`;
            }
            html += '</tr>';
        }
        
        html += '</tbody></table></div>';
        
        // Legenda
        html += '<div class="mt-3 p-3 legenda-preview">';
        html += '<strong><i class="bi bi-info-circle"></i> Legenda:</strong> ';
        html += '<span class="badge bg-success me-2">Sem Taxa</span> ';
        html += '<span class="badge bg-primary me-2">Auto</span> Calculado automaticamente | ';
        html += '<span class="badge bg-purple">Custom</span> Preço customizado definido';
        
        if (imposto4Ativo) {
            html += '<br><br><strong class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> IMPOSTO 4% ATIVO:</strong> Todos os preços acima já incluem o imposto.';
        }
        
        html += '</div>';
        
        $('#preview-precos-container').html(html);
    }
    
    // TOGGLE DE PREÇOS CUSTOMIZADOS
    $('#preco_customizado_cartao').change(function() {
        const customizado = $(this).is(':checked');
        
        if (customizado) {
            $('#card-precos-customizados').slideDown(300);
            
            const precoVista = parseFloat($('#preco_venda_dinheiro').val()) || 0;
            if (precoVista > 0) {
                for (let parcela = 2; parcela <= 12; parcela++) {
                    const campo = $(`#preco_credito_${parcela}x`);
                    if (!campo.val() || parseFloat(campo.val()) === 0) {
                        let preco = calcularPrecoComTaxa(precoVista, TAXAS.CREDITO[parcela]);
                        preco = aplicarImposto4(preco);
                        campo.val(preco.toFixed(2));
                    }
                }
            }
        } else {
            $('#card-precos-customizados').slideUp(300);
        }
        
        atualizarPreview();
    });
    
    // TOGGLE DE IMPOSTO 4%
    $('#aplicar_imposto_4').change(function() {
        const ativo = $(this).is(':checked');
        
        if (ativo) {
            $('#aviso-imposto-4').slideDown(300);
        } else {
            $('#aviso-imposto-4').slideUp(300);
        }
        
        atualizarPreview();
    });
    
    // ATUALIZAR INFOS DAS TAXAS
    function atualizarInfoTaxas() {
        const precoVista = parseFloat($('#preco_venda_dinheiro').val()) || 0;
        
        if (precoVista > 0) {
            for (let parcela = 2; parcela <= 12; parcela++) {
                let precoAuto = calcularPrecoComTaxa(precoVista, TAXAS.CREDITO[parcela]);
                precoAuto = aplicarImposto4(precoAuto);
                $(`.taxa-info-${parcela}`).html(`Sugestão: R$ ${precoAuto.toFixed(2)} (Taxa: ${TAXAS.CREDITO[parcela]}%)`);
            }
        }
    }
    
    // EVENTOS
    $('#preco_custo, #preco_venda_dinheiro').on('change keyup', function() {
        setTimeout(validarMargem, 200);
        setTimeout(atualizarInfoTaxas, 200);
    });
    
    $('.preco-customizado').on('change', function() {
        atualizarPreview();
    });
    
    // INICIALIZAÇÃO
    setTimeout(function() {
        validarMargem();
        atualizarInfoTaxas();
        
        if ($('#preco_customizado_cartao').is(':checked')) {
            $('#card-precos-customizados').show();
        }
        
        if ($('#aplicar_imposto_4').is(':checked')) {
            $('#aviso-imposto-4').show();
        }
        
        const precoVista = parseFloat($('#preco_venda_dinheiro').val()) || 0;
        if (precoVista > 0) {
            atualizarPreview();
        }
        
        console.log('✅ Sistema de preços inicializado!');
    }, 500);
    
});

// CSS ADICIONAL PARA LEGENDA NO MODO ESCURO
const styleTag = document.createElement('style');
styleTag.innerHTML = `
    .legenda-preview {
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    body.dark-mode .legenda-preview {
        background: #1a1a1a;
        color: #e0e0e0;
    }
    
    .badge.bg-purple {
        background-color: #6f42c1 !important;
    }
`;
document.head.appendChild(styleTag);


$(document).ready(function() {
    
    const $categoria = $('#id_categoria');
    const $subcategoria = $('#id_subcategoria');
    const $grupo = $('#id_grupo');
    const $subgrupo = $('#id_subgrupo');
    
    // Valores iniciais (para quando estiver editando um produto)
    const categoriaInicial = '{{ form.categoria.value|default:"" }}';
    const subcategoriaInicial = '{{ form.subcategoria.value|default:"" }}';
    const grupoInicial = '{{ form.grupo.value|default:"" }}';
    const subgrupoInicial = '{{ form.subgrupo.value|default:"" }}';
    
    // ============================================================
    // CATEGORIA -> SUBCATEGORIA
    // ============================================================
    $categoria.on('change', function() {
        const categoriaId = $(this).val();
        
        // Limpar selects dependentes
        $subcategoria.html('<option value="">Carregando...</option>');
        $grupo.html('<option value="">Selecione a subcategoria primeiro...</option>');
        $subgrupo.html('<option value="">Selecione o grupo primeiro...</option>');
        
        if (!categoriaId) {
            $subcategoria.html('<option value="">Selecione a categoria primeiro...</option>');
            return;
        }
        
        // Buscar subcategorias via AJAX
        $.ajax({
            url: '/api/subcategorias/',
            data: { categoria_id: categoriaId },
            dataType: 'json',
            success: function(response) {
                let options = '<option value="">Selecione...</option>';
                
                const dados = response.subcategorias || response.resultados || [];
                
                if (dados.length > 0) {
                    dados.forEach(function(item) {
                        const selected = (item.id == subcategoriaInicial) ? 'selected' : '';
                        options += `<option value="${item.id}" ${selected}>${item.nome}</option>`;
                    });
                } else {
                    options = '<option value="">Nenhuma subcategoria cadastrada</option>';
                }
                
                $subcategoria.html(options);
                
                // Se tinha valor inicial, disparar change para carregar grupos
                if (subcategoriaInicial && $subcategoria.val()) {
                    $subcategoria.trigger('change');
                }
            },
            error: function() {
                $subcategoria.html('<option value="">Erro ao carregar</option>');
            }
        });
    });
    
    // ============================================================
    // SUBCATEGORIA -> GRUPO
    // ============================================================
    $subcategoria.on('change', function() {
        const subcategoriaId = $(this).val();
        
        // Limpar selects dependentes
        $grupo.html('<option value="">Carregando...</option>');
        $subgrupo.html('<option value="">Selecione o grupo primeiro...</option>');
        
        if (!subcategoriaId) {
            $grupo.html('<option value="">Selecione a subcategoria primeiro...</option>');
            return;
        }
        
        // Buscar grupos via AJAX
        $.ajax({
            url: '/api/grupos/',
            data: { subcategoria_id: subcategoriaId },
            dataType: 'json',
            success: function(response) {
                let options = '<option value="">Selecione...</option>';
                
                const dados = response.grupos || [];
                
                if (dados.length > 0) {
                    dados.forEach(function(item) {
                        const selected = (item.id == grupoInicial) ? 'selected' : '';
                        options += `<option value="${item.id}" ${selected}>${item.nome}</option>`;
                    });
                } else {
                    options = '<option value="">Nenhum grupo cadastrado</option>';
                }
                
                $grupo.html(options);
                
                // Se tinha valor inicial, disparar change para carregar subgrupos
                if (grupoInicial && $grupo.val()) {
                    $grupo.trigger('change');
                }
            },
            error: function() {
                $grupo.html('<option value="">Erro ao carregar</option>');
            }
        });
    });
    
    // ============================================================
    // GRUPO -> SUBGRUPO
    // ============================================================
    $grupo.on('change', function() {
        const grupoId = $(this).val();
        
        // Limpar select dependente
        $subgrupo.html('<option value="">Carregando...</option>');
        
        if (!grupoId) {
            $subgrupo.html('<option value="">Selecione o grupo primeiro...</option>');
            return;
        }
        
        // Buscar subgrupos via AJAX
        $.ajax({
            url: '/api/subgrupos/',
            data: { grupo_id: grupoId },
            dataType: 'json',
            success: function(response) {
                let options = '<option value="">Selecione...</option>';
                
                const dados = response.subgrupos || [];
                
                if (dados.length > 0) {
                    dados.forEach(function(item) {
                        const selected = (item.id == subgrupoInicial) ? 'selected' : '';
                        options += `<option value="${item.id}" ${selected}>${item.nome}</option>`;
                    });
                } else {
                    options = '<option value="">Nenhum subgrupo cadastrado</option>';
                }
                
                $subgrupo.html(options);
            },
            error: function() {
                $subgrupo.html('<option value="">Erro ao carregar</option>');
            }
        });
    });
    
    // ============================================================
    // INICIALIZAÇÃO - Carregar cascata se estiver editando
    // ============================================================
    if (categoriaInicial && $categoria.val()) {
        // Disparar change para carregar a cascata completa
        $categoria.trigger('change');
    }
    
    console.log('✅ Hierarquia de categorias em cascata inicializada!');
});

</script>


{% endblock %}