{% extends 'base.html' %}
{% load static %}

{% block title %}{% if editando %}Editar{% else %}Novo{% endif %} Produto{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Mensagens de erro/sucesso -->
    {% if messages %}
    <div class="messages-container mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="bi bi-box-seam"></i>
                {% if editando %}Editar Produto{% else %}Cadastrar Novo Produto{% endif %}
            </h4>
        </div>
        <div class="card-body">

            <form method="post" enctype="multipart/form-data" id="produtoForm">
                {% csrf_token %}

                <!-- ABAS -->
                <ul class="nav nav-tabs mb-4" id="produtoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="identificacao-tab" data-bs-toggle="tab" 
                                data-bs-target="#identificacao" type="button">
                            <i class="bi bi-tag"></i> Identificação
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="localizacao-tab" data-bs-toggle="tab" 
                                data-bs-target="#localizacao" type="button">
                            <i class="bi bi-pin-map"></i> Localização
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="precos-tab" data-bs-toggle="tab" 
                                data-bs-target="#precos" type="button">
                            <i class="bi bi-cash-stack"></i> Preços
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="estoque-tab" data-bs-toggle="tab" 
                                data-bs-target="#estoque" type="button">
                            <i class="bi bi-boxes"></i> Estoque
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="veiculos-tab" data-bs-toggle="tab" 
                                data-bs-target="#veiculos" type="button">
                            <i class="bi bi-car-front"></i> Veículos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="outros-tab" data-bs-toggle="tab" 
                                data-bs-target="#outros" type="button">
                            <i class="bi bi-three-dots"></i> Outros
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="produtoTabContent">

                    <!-- ABA 1: IDENTIFICAÇÃO -->
                    <div class="tab-pane fade show active" id="identificacao" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-tag-fill"></i> Dados de Identificação
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Código Interno *</label>
                                        <input type="text" name="codigo" 
                                               class="form-control {% if form.codigo.errors %}is-invalid{% endif %}" 
                                               value="{{ form.codigo.value|default:'' }}" required>
                                        {% if form.codigo.errors %}
                                        <div class="invalid-feedback">{{ form.codigo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">SKU</label>
                                        <input type="text" name="codigo_sku" 
                                               class="form-control" 
                                               value="{{ form.codigo_sku.value|default:'' }}">
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Código de Barras</label>
                                        <input type="text" name="codigo_barras" 
                                               class="form-control" 
                                               value="{{ form.codigo_barras.value|default:'' }}">
                                    </div>
                                    
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Descrição *</label>
                                        <input type="text" name="descricao" 
                                               class="form-control {% if form.descricao.errors %}is-invalid{% endif %}" 
                                               value="{{ form.descricao.value|default:'' }}" required>
                                        {% if form.descricao.errors %}
                                        <div class="invalid-feedback">{{ form.descricao.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label class="form-label">Descrição Detalhada</label>
                                        <textarea name="descricao_detalhada" 
                                                  class="form-control" 
                                                  rows="3">{{ form.descricao_detalhada.value|default:'' }}</textarea>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Categoria</label>
                                        <select name="categoria" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for categoria in form.fields.categoria.queryset %}
                                            <option value="{{ categoria.id }}" 
                                                    {% if form.categoria.value == categoria.id %}selected{% endif %}>
                                                {{ categoria.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Subcategoria</label>
                                        <select name="subcategoria" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for sub in form.fields.subcategoria.queryset %}
                                            <option value="{{ sub.id }}" 
                                                    {% if form.subcategoria.value == sub.id %}selected{% endif %}>
                                                {{ sub.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Fabricante</label>
                                        <select name="fabricante" class="form-select">
                                            <option value="">Selecione...</option>
                                            {% for fab in form.fields.fabricante.queryset %}
                                            <option value="{{ fab.id }}" 
                                                    {% if form.fabricante.value == fab.id %}selected{% endif %}>
                                                {{ fab.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 2: LOCALIZAÇÃO -->
                    <div class="tab-pane fade" id="localizacao" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-pin-map-fill"></i> Localização no Estoque
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Loja</label>
                                        <input type="text" name="loja" 
                                               class="form-control" 
                                               value="{{ form.loja.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Setor</label>
                                        <input type="text" name="setor" 
                                               class="form-control" 
                                               value="{{ form.setor.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Prateleira</label>
                                        <input type="text" name="prateleira" 
                                               class="form-control" 
                                               value="{{ form.prateleira.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Divisão</label>
                                        <input type="text" name="divisao_prateleira" 
                                               class="form-control" 
                                               value="{{ form.divisao_prateleira.value|default:'' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 3: PREÇOS -->
                    <div class="tab-pane fade" id="precos" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-cash-stack"></i> Preços e Margens
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Preço de Custo *</label>
                                        <input type="number" step="0.01" name="preco_custo" 
                                               class="form-control" 
                                               value="{{ form.preco_custo.value|default:'0.00' }}" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Preço Venda - Dinheiro/PIX</label>
                                        <input type="number" step="0.01" name="preco_venda_dinheiro" 
                                               class="form-control" 
                                               value="{{ form.preco_venda_dinheiro.value|default:'0.00' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Preço Venda - Débito</label>
                                        <input type="number" step="0.01" name="preco_venda_debito"
                                            class="form-control"
                                            value="{{ form.preco_venda_debito.value|default:'0.00' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Preço Venda - Crédito</label>
                                        <input type="number" step="0.01" name="preco_venda_credito" 
                                               class="form-control" 
                                               value="{{ form.preco_venda_credito.value|default:'0.00' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Preço Atacado</label>
                                        <input type="number" step="0.01" name="preco_atacado" 
                                               class="form-control" 
                                               value="{{ form.preco_atacado.value|default:'0.00' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Qtd Mínima Atacado</label>
                                        <input type="number" name="quantidade_minima_atacado" 
                                               class="form-control" 
                                               value="{{ form.quantidade_minima_atacado.value|default:'1' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Preço Promocional</label>
                                        <input type="number" step="0.01" name="preco_promocional" 
                                               class="form-control" 
                                               value="{{ form.preco_promocional.value|default:'0.00' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 4: ESTOQUE -->
                    <div class="tab-pane fade" id="estoque" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-boxes"></i> Gerenciamento de Estoque
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Estoque Atual</label>
                                        <input type="number" step="0.01" name="estoque_atual" 
                                               class="form-control" 
                                               value="{{ form.estoque_atual.value|default:'0' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Estoque Mínimo</label>
                                        <input type="number" step="0.01" name="estoque_minimo" 
                                               class="form-control" 
                                               value="{{ form.estoque_minimo.value|default:'0' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Estoque Máximo</label>
                                        <input type="number" step="0.01" name="estoque_maximo" 
                                               class="form-control" 
                                               value="{{ form.estoque_maximo.value|default:'0' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 5: VEÍCULOS -->
                    <div class="tab-pane fade" id="veiculos" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-car-front"></i> Veículos Compatíveis (Múltiplos)
                                </h5>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">1. Montadora</label>
                                        <select id="select-montadora" class="form-select">
                                            <option value="">Escolha...</option>
                                            {% for m in montadoras %}
                                            <option value="{{ m.id }}">{{ m.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">2. Modelo</label>
                                        <select id="select-modelo" class="form-select" disabled>
                                            <option>Selecione a montadora...</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="versoes-container" class="mb-3"></div>

                                <button type="button" id="btn-adicionar-modelo" 
                                        class="btn btn-success" disabled>
                                    <i class="bi bi-plus-circle"></i> Adicionar Versões Selecionadas
                                </button>

                                <div class="mt-4">
                                    <h6><i class="bi bi-check-circle"></i> Versões Adicionadas:</h6>
                                    <div id="lista-modelos-selecionados" class="modelos-lista">
                                        {% if editando and produto.versoes_compativeis.exists %}
                                            {% for v in produto.versoes_compativeis.all %}
                                            <div class="modelo-badge" data-versao-id="{{ v.id }}">
                                                <span>
                                                    <i class="bi bi-car-front-fill"></i>
                                                    {{ v.modelo.montadora.nome }} {{ v.modelo.nome }} 
                                                    <strong>{{ v.nome }}</strong> ({{ v.get_anos_range }})
                                                </span>
                                                <input type="hidden" name="versoes_compativeis" value="{{ v.id }}">
                                                <button type="button" class="btn-remover" 
                                                        onclick="removerVersao({{ v.id }})">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted" id="msg-sem-modelos">
                                                Nenhuma versão adicionada...
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 6: OUTROS -->
                    <div class="tab-pane fade" id="outros" role="tabpanel">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-three-dots"></i> Informações Adicionais
                                </h5>

                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Peso (kg)</label>
                                        <input type="number" step="0.001" name="peso" 
                                               class="form-control" 
                                               value="{{ form.peso.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Altura (cm)</label>
                                        <input type="number" step="0.01" name="altura" 
                                               class="form-control" 
                                               value="{{ form.altura.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Largura (cm)</label>
                                        <input type="number" step="0.01" name="largura" 
                                               class="form-control" 
                                               value="{{ form.largura.value|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Comprimento (cm)</label>
                                        <input type="number" step="0.01" name="comprimento" 
                                               class="form-control" 
                                               value="{{ form.comprimento.value|default:'' }}">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">NCM</label>
                                        <input type="text" name="ncm" 
                                               class="form-control" 
                                               value="{{ form.ncm.value|default:'' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Unidade</label>
                                        <input type="text" name="unidade_medida" 
                                               class="form-control" 
                                               value="{{ form.unidade_medida.value|default:'UN' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Garantia (meses)</label>
                                        <input type="number" name="garantia_meses" 
                                               class="form-control" 
                                               value="{{ form.garantia_meses.value|default:'0' }}">
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="ativo" id="ativo"
                                                   {% if not editando or form.ativo.value %}checked{% endif %}>
                                            <label class="form-check-label" for="ativo">
                                                Produto Ativo
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="destaque" id="destaque"
                                                   {% if form.destaque.value %}checked{% endif %}>
                                            <label class="form-check-label" for="destaque">
                                                Produto em Destaque
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <label class="form-label">Imagem do Produto</label>
                                        <input type="file" name="imagem" 
                                               class="form-control" 
                                               accept="image/*">
                                        {% if editando and produto.imagem %}
                                        <small class="text-muted">Imagem atual: {{ produto.imagem.name }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- tab-content -->

                <!-- BOTÕES -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'lista_estoque' %}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                    <button class="btn btn-success btn-lg" type="submit">
                        <i class="bi bi-check-circle"></i> 
                        {% if editando %}Atualizar Produto{% else %}Cadastrar Produto{% endif %}
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<style>
.versoes-checklist {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    max-height: 350px;
    overflow-y: auto;
    border: 2px solid #dee2e6;
}

.versoes-checklist h6 {
    color: #495057;
    margin-bottom: 15px;
    position: sticky;
    top: 0;
    background: #f8f9fa;
    padding-bottom: 10px;
}

.versoes-checklist .form-check {
    padding: 10px 15px;
    margin-bottom: 8px;
    background: white;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.2s;
}

.versoes-checklist .form-check:hover {
    background: #e9ecef;
    border-color: #0d6efd;
}

.modelos-lista {
    min-height: 100px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #dee2e6;
}

.modelo-badge {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    margin: 5px;
    font-size: 14px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.modelo-badge span {
    margin-right: 10px;
}

.btn-remover {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-remover:hover {
    background: rgba(255,255,255,0.4);
    transform: scale(1.1);
}

.nav-tabs .nav-link {
    color: #495057;
}

.nav-tabs .nav-link.active {
    font-weight: bold;
}

.card-title {
    color: #2d3748;
    font-weight: 600;
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {

    // Carregar modelos ao selecionar montadora
    $('#select-montadora').change(function() {
        const montadoraId = $(this).val();
        const modeloSelect = $('#select-modelo');
        const versoesContainer = $('#versoes-container');

        modeloSelect.html('<option value="">Carregando...</option>').prop('disabled', true);
        versoesContainer.html('');
        $('#btn-adicionar-modelo').prop('disabled', true);

        if (!montadoraId) {
            modeloSelect.html('<option value="">Selecione a montadora primeiro</option>');
            return;
        }

        $.get('/api/modelos/?montadora_id=' + montadoraId, function(data) {
            if (data.success && data.modelos.length > 0) {
                let html = '<option value="">Selecione o modelo...</option>';
                data.modelos.forEach(modelo => {
                    html += `<option value="${modelo.id}">${modelo.nome} (${modelo.total_versoes} versões)</option>`;
                });
                modeloSelect.html(html).prop('disabled', false);
            } else {
                modeloSelect.html('<option value="">Nenhum modelo encontrado</option>');
            }
        }).fail(function() {
            alert('Erro ao carregar modelos. Verifique a URL /api/modelos/');
        });
    });

    // Carregar versões ao selecionar modelo
    $('#select-modelo').change(function() {
        const modeloId = $(this).val();
        const versoesContainer = $('#versoes-container');

        versoesContainer.html('');
        $('#btn-adicionar-modelo').prop('disabled', true);

        if (!modeloId) {
            return;
        }

        $.get('/api/versoes/?modelo_id=' + modeloId, function(data) {
            if (data.success && data.versoes.length > 0) {

                let html = '<div class="versoes-checklist">';
                html += '<h6><i class="bi bi-check-square"></i> 3. Marque as versões compatíveis:</h6>';
                html += `
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="toggle-all">
                            <i class="bi bi-check-all"></i> Marcar/Desmarcar Todas
                        </button>
                    </div>
                `;

                data.versoes.forEach(versao => {
                    html += `
                        <div class="form-check">
                            <input class="form-check-input versao-checkbox" type="checkbox" 
                                value="${versao.id}" 
                                id="versao_${versao.id}"
                                data-montadora="${$('#select-montadora option:selected').text()}"
                                data-modelo="${$('#select-modelo option:selected').text()}"
                                data-versao="${versao.nome}"
                                data-anos="${versao.anos_range}"
                                data-motores="${versao.motorizacoes}">
                            <label class="form-check-label" for="versao_${versao.id}">
                                <strong>${versao.nome}</strong> (${versao.anos_range}) - ${versao.motorizacoes}
                            </label>
                        </div>
                    `;
                });

                html += '</div>';

                versoesContainer.html(html);
                $('#btn-adicionar-modelo').prop('disabled', false);

                // Toggle all checkboxes
                $('#toggle-all').click(function() {
                    const checkboxes = $('.versao-checkbox');
                    const allChecked = checkboxes.filter(':checked').length === checkboxes.length;
                    checkboxes.prop('checked', !allChecked);
                });
            }
        }).fail(function() {
            alert('Erro ao carregar versões. Verifique a URL /api/versoes/');
        });
    });

    // Adicionar versões selecionadas
    $('#btn-adicionar-modelo').click(function() {
        const checkedBoxes = $('.versao-checkbox:checked');

        if (checkedBoxes.length === 0) {
            alert('Selecione pelo menos uma versão!');
            return;
        }

        const lista = $('#lista-modelos-selecionados');
        $('#msg-sem-modelos').remove();

        let count = 0;
        checkedBoxes.each(function() {
            const c = $(this);
            const id = c.val();

            // Verificar se já foi adicionado
            if ($(`[data-versao-id="${id}"]`).length > 0) {
                return;
            }

            const html = `
                <div class="modelo-badge" data-versao-id="${id}">
                    <span>
                        <i class="bi bi-car-front-fill"></i>
                        ${c.data('montadora')} ${c.data('modelo')} 
                        <strong>${c.data('versao')}</strong> (${c.data('anos')})
                    </span>
                    <input type="hidden" name="versoes_compativeis" value="${id}">
                    <button type="button" class="btn-remover" onclick="removerVersao(${id})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;

            lista.append(html);
            count++;
        });

        // Limpar seleção
        $('#select-montadora').val('');
        $('#select-modelo').html('<option value="">Selecione a montadora primeiro</option>').prop('disabled', true);
        $('#versoes-container').html('');
        $('#btn-adicionar-modelo').prop('disabled', true);

        // Feedback
        alert(`✅ ${count} versão(ões) adicionada(s) com sucesso!`);
    });
});

// Função global para remover versão
function removerVersao(id) {
    if (confirm('Remover esta versão do produto?')) {
        $(`[data-versao-id="${id}"]`).remove();

        // Se não sobrou nenhuma, mostrar mensagem
        if ($('.modelo-badge').length === 0) {
            $('#lista-modelos-selecionados').html(
                '<p class="text-muted" id="msg-sem-modelos">Nenhuma versão adicionada...</p>'
            );
        }
    }
}
</script>
{% endblock %}