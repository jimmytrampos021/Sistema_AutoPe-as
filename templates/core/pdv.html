{% extends 'base.html' %}

{% block title %}PDV - Sistema Autope√ßas{% endblock %}

{% block page_title %}Ponto de Venda (PDV){% endblock %}

{% block extra_css %}
<style>
    .pdv-container {
        display: grid;
        grid-template-columns: 1fr 450px;
        gap: 20px;
        height: calc(100vh - 180px);
    }
    
    .produtos-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        overflow-y: auto;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .carrinho-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .produto-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
    }
    
    .produto-card:hover {
        border-color: #0d6efd;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(13,110,253,0.2);
    }
    
    .produto-card.selected {
        border-color: #0d6efd;
        background: #e7f1ff;
    }
    
    .produto-card.sem-estoque {
        border-color: #dc3545;
        opacity: 0.7;
    }
    
    .produto-card.sem-estoque:hover {
        border-color: #dc3545;
        opacity: 1;
    }
    
    .produto-codigo {
        font-size: 12px;
        color: #6c757d;
        font-weight: bold;
    }
    
    .produto-nome {
        font-size: 16px;
        font-weight: 600;
        margin: 5px 0;
    }
    
    .produto-estoque {
        font-size: 13px;
        color: #6c757d;
    }
    
    .produto-estoque.alerta {
        color: #dc3545;
        font-weight: bold;
    }
    
    .produto-preco {
        font-size: 20px;
        color: #198754;
        font-weight: bold;
        margin-top: 8px;
    }
    
    .carrinho-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 10px;
    }
    
    .carrinho-item:last-child {
        border-bottom: none;
    }
    
    .carrinho-item.sem-estoque-warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
    }
    
    .item-qtd-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .item-qtd-control button {
        width: 30px;
        height: 30px;
        padding: 0;
        border-radius: 50%;
    }
    
    .carrinho-total {
        margin-top: auto;
        padding-top: 20px;
        border-top: 3px solid #0d6efd;
    }
    
    .total-valor {
        font-size: 32px;
        font-weight: bold;
        color: #0d6efd;
        text-align: center;
        margin: 15px 0;
    }
    
    .search-box {
        position: sticky;
        top: 0;
        background: white;
        padding-bottom: 15px;
        z-index: 10;
    }
    
    body.dark-mode .search-box {
        background: #2d2d2d;
    }
    
    .search-counter {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .produto-card.selected {
        animation: pulseGreen 0.3s ease;
    }
    
    @keyframes pulseGreen {
        0%, 100% { transform: scale(1); border-color: #e9ecef; }
        50% { transform: scale(1.05); border-color: #198754; background-color: #d1e7dd; }
    }
    
    #search-produto:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        border-color: #0d6efd;
    }
    
    .empty-cart {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-cart i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .badge-sem-estoque {
        background-color: #dc3545;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 5px;
    }
    
    /* Loading spinner */
    .loading-spinner {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }
    
    /* Modo Escuro */
    body.dark-mode .pdv-container {
        color: #e0e0e0;
    }
    
    body.dark-mode .produtos-section,
    body.dark-mode .carrinho-section {
        background: #2d2d2d;
        color: #e0e0e0;
    }
    
    body.dark-mode .produto-card {
        background: #1a1a1a;
        border-color: #444;
        color: #e0e0e0;
    }
    
    body.dark-mode .produto-card:hover {
        border-color: #0d6efd;
        background: #2a2a2a;
    }
    
    body.dark-mode .produto-card.selected {
        background: #1a3a5a;
        border-color: #0d6efd;
    }
    
    body.dark-mode .produto-codigo,
    body.dark-mode .produto-estoque {
        color: #999;
    }
    
    body.dark-mode .produto-nome {
        color: #e0e0e0;
    }
    
    body.dark-mode .carrinho-item {
        border-bottom-color: #444;
    }
    
    body.dark-mode .empty-cart {
        color: #999;
    }
    
    body.dark-mode .form-select,
    body.dark-mode .form-control {
        background: #1a1a1a;
        border-color: #444;
        color: #e0e0e0;
    }
    
    body.dark-mode .form-select:focus,
    body.dark-mode .form-control:focus {
        background: #2a2a2a;
        border-color: #0d6efd;
        color: #e0e0e0;
    }
    
    body.dark-mode .search-counter,
    body.dark-mode .loading-spinner {
        color: #999;
    }
    
    /* Badge de parcelas */
    .badge-parcela {
        background: #0d6efd;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-left: 5px;
    }
    
    /* Info de desconto/acr√©scimo */
    #info-ajuste {
        background: #e7f1ff;
        padding: 5px 8px;
        border-radius: 5px;
        border-left: 3px solid #0d6efd;
    }
    
    body.dark-mode #info-ajuste {
        background: #1a3a5a;
        border-left-color: #4a90e2;
        color: #a0c4ff;
    }
    
    .total-breakdown {
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .total-breakdown .row {
        padding: 3px 0;
    }
    
    .total-breakdown .label {
        color: #6c757d;
    }
    
    .total-breakdown .value {
        font-weight: 600;
    }
    
    .total-breakdown .desconto {
        color: #198754;
    }
    
    .total-breakdown .acrescimo {
        color: #dc3545;
    }
    
    body.dark-mode .total-breakdown .label {
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="pdv-container">
    <!-- Se√ß√£o de Produtos -->
    <div class="produtos-section">
        <div class="search-box">
            <h4><i class="bi bi-box-seam"></i> Produtos</h4>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="search-produto" class="form-control form-control-lg" 
                       placeholder="Digite para buscar (m√≠nimo 2 caracteres)..." 
                       autocomplete="off">
            </div>
            <div class="search-counter" id="search-counter">
                Mostrando {{ produtos|length }} de {{ total_produtos }} produtos
            </div>
        </div>
        
        <div id="lista-produtos" class="mt-3">
            {% for produto in produtos %}
            <div class="produto-card {% if produto.estoque_atual <= 0 %}sem-estoque{% endif %}" 
                 data-id="{{ produto.id }}" 
                 data-codigo="{{ produto.codigo }}"
                 data-codigo-barras="{% if produto.codigo_barras %}{{ produto.codigo_barras }}{% endif %}"
                 data-descricao="{{ produto.descricao }}" 
                 data-preco="{{ produto.preco_venda_dinheiro }}"
                 data-estoque="{{ produto.estoque_atual }}">
                <div class="produto-codigo">
                    {{ produto.codigo }}
                    {% if produto.codigo_barras %} | <small>{{ produto.codigo_barras }}</small>{% endif %}
                    {% if produto.estoque_atual <= 0 %}
                        <span class="badge-sem-estoque">SEM ESTOQUE</span>
                    {% endif %}
                </div>
                <div class="produto-nome">{{ produto.descricao }}</div>
                <div class="row">
                    <div class="col-6">
                        <div class="produto-estoque {% if produto.estoque_atual <= 0 %}alerta{% endif %}">
                            <i class="bi bi-box"></i> Estoque: {{ produto.estoque_atual }}
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="produto-preco">R$ {{ produto.preco_venda_dinheiro }}</div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted p-5">
                <i class="bi bi-inbox" style="font-size: 48px;"></i>
                <p>Nenhum produto dispon√≠vel</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Se√ß√£o do Carrinho -->
    <div class="carrinho-section">
        <h4><i class="bi bi-cart3"></i> Carrinho</h4>
        
        <!-- Cliente -->
        <div class="mb-3">
            <label class="form-label">Cliente <small class="text-muted">(opcional)</small></label>
            <select id="cliente-select" class="form-select">
                <option value="">N√£o informado</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nome }} - {{ cliente.cpf_cnpj }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Forma de Pagamento -->
        <div class="mb-3">
            <label class="form-label">Forma de Pagamento</label>
            <select id="forma-pagamento" class="form-select">
                <option value="DI">üíµ Dinheiro/PIX</option>
                <option value="DB">üí≥ D√©bito</option>
                <option value="CC">üí≥ Cr√©dito √† Vista</option>
                <option value="CP">üí≥ Cr√©dito Parcelado</option>
            </select>
        </div>
        
        <!-- Parcelas (aparece apenas se Cr√©dito Parcelado) -->
        <div id="parcelas-container" class="mb-3" style="display: none;">
            <label class="form-label">N√∫mero de Parcelas</label>
            <select id="numero-parcelas" class="form-select">
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="5">5x</option>
                <option value="6">6x</option>
                <option value="7">7x</option>
                <option value="8">8x</option>
                <option value="9">9x</option>
                <option value="10">10x</option>
                <option value="11">11x</option>
                <option value="12">12x</option>
            </select>
        </div>
        
        <!-- Desconto/Acr√©scimo -->
        <div class="mb-3">
            <label class="form-label">üí∞ Desconto/Acr√©scimo</label>
            <div class="row g-2">
                <div class="col-5">
                    <select id="tipo-ajuste" class="form-select form-select-sm">
                        <option value="">Nenhum</option>
                        <option value="desconto">Desconto</option>
                        <option value="acrescimo">Acr√©scimo</option>
                    </select>
                </div>
                <div class="col-4">
                    <input type="number" id="valor-ajuste" class="form-control form-control-sm" 
                           placeholder="0.00" step="0.01" min="0" disabled>
                </div>
                <div class="col-3">
                    <select id="tipo-valor-ajuste" class="form-select form-select-sm" disabled>
                        <option value="reais">R$</option>
                        <option value="percent">%</option>
                    </select>
                </div>
            </div>
            <div id="info-ajuste" class="mt-1" style="font-size: 11px; color: #6c757d; display: none;">
                <i class="bi bi-info-circle"></i> <span id="info-ajuste-texto"></span>
            </div>
        </div>
        
        <!-- Itens do Carrinho -->
        <div id="carrinho-itens" style="flex: 1; overflow-y: auto; max-height: 250px;">
            <div class="empty-cart">
                <i class="bi bi-cart-x"></i>
                <p>Carrinho vazio<br>Clique nos produtos para adicionar</p>
            </div>
        </div>
        
        <!-- Total e Finaliza√ß√£o -->
        <div class="carrinho-total">
            <!-- Detalhamento do Total -->
            <div class="total-breakdown" id="total-breakdown" style="display: none;">
                <div class="row">
                    <div class="col-6 label">Subtotal:</div>
                    <div class="col-6 text-end value" id="valor-subtotal">R$ 0,00</div>
                </div>
                <div class="row" id="row-ajuste" style="display: none;">
                    <div class="col-6 label" id="label-ajuste">Desconto:</div>
                    <div class="col-6 text-end value" id="valor-ajuste-display">R$ 0,00</div>
                </div>
                <hr style="margin: 8px 0;">
            </div>
            
            <div class="total-valor" id="total-geral">R$ 0,00</div>
            
            <div class="d-grid gap-2">
                <button id="btn-finalizar" class="btn btn-success btn-lg">
                    <i class="bi bi-check-circle"></i> Finalizar Venda (F4)
                </button>
                <button id="btn-limpar" class="btn btn-outline-danger">
                    <i class="bi bi-x-circle"></i> Limpar Carrinho
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let carrinho = [];
let buscaTimeout = null;
let ultimaBusca = '';
let ajusteAtual = {
    tipo: '',      // 'desconto' ou 'acrescimo'
    valor: 0,      // valor num√©rico
    tipoValor: 'reais'  // 'reais' ou 'percent'
};

// ============================================
// BUSCA AJAX DE PRODUTOS
// ============================================
$('#search-produto').on('input', function() {
    const query = $(this).val().trim();
    
    // Limpar timeout anterior
    if (buscaTimeout) {
        clearTimeout(buscaTimeout);
    }
    
    // Se busca vazia, mostrar produtos iniciais
    if (query.length === 0) {
        $('#search-counter').text('Mostrando produtos recentes');
        return;
    }
    
    // Aguardar 300ms antes de buscar (debounce)
    buscaTimeout = setTimeout(function() {
        if (query.length < 2) {
            $('#search-counter').html('<span class="text-muted">Digite pelo menos 2 caracteres</span>');
            return;
        }
        
        // Evitar buscar a mesma coisa
        if (query === ultimaBusca) {
            return;
        }
        
        ultimaBusca = query;
        buscarProdutos(query);
    }, 300);
});

function buscarProdutos(query) {
    // Mostrar loading
    $('#lista-produtos').html(`
        <div class="loading-spinner">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Buscando...</span>
            </div>
            <p class="mt-2">Buscando produtos...</p>
        </div>
    `);
    
    $('#search-counter').html('<span class="spinner-border spinner-border-sm me-2"></span>Buscando...');
    
    // Fazer requisi√ß√£o AJAX
    $.ajax({
        url: '{% url "api_buscar_produtos_pdv" %}',
        method: 'GET',
        data: { q: query },
        success: function(response) {
            renderizarProdutos(response.produtos);
            $('#search-counter').text(`${response.total} produto(s) encontrado(s)`);
        },
        error: function(xhr, status, error) {
            console.error('Erro na busca:', error);
            $('#lista-produtos').html(`
                <div class="text-center text-danger p-5">
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
                    <p>Erro ao buscar produtos</p>
                    <small>${error}</small>
                </div>
            `);
            $('#search-counter').html('<span class="text-danger">Erro na busca</span>');
        }
    });
}

function renderizarProdutos(produtos) {
    const container = $('#lista-produtos');
    container.empty();
    
    if (produtos.length === 0) {
        container.html(`
            <div class="text-center text-muted p-5">
                <i class="bi bi-inbox" style="font-size: 48px;"></i>
                <p>Nenhum produto encontrado</p>
            </div>
        `);
        return;
    }
    
    produtos.forEach(produto => {
        const semEstoque = produto.estoque_atual <= 0;
        const badgeSemEstoque = semEstoque ? '<span class="badge-sem-estoque">SEM ESTOQUE</span>' : '';
        const codigoBarras = produto.codigo_barras ? ` | <small>${produto.codigo_barras}</small>` : '';
        
        const html = `
            <div class="produto-card ${semEstoque ? 'sem-estoque' : ''}" 
                 data-id="${produto.id}" 
                 data-codigo="${produto.codigo}"
                 data-codigo-barras="${produto.codigo_barras}"
                 data-descricao="${produto.descricao}" 
                 data-preco="${produto.preco_venda_dinheiro}"
                 data-preco-debito="${produto.preco_venda_debito}"
                 data-preco-credito="${produto.preco_venda_credito}"
                 data-estoque="${produto.estoque_atual}"
                 data-imposto="${produto.aplicar_imposto_4}"
                 data-customizado="${produto.preco_customizado_cartao}"
                 data-precos-credito='${JSON.stringify(produto.precos_credito)}'>
                <div class="produto-codigo">
                    ${produto.codigo}${codigoBarras}${badgeSemEstoque}
                </div>
                <div class="produto-nome">${produto.descricao}</div>
                <div class="row">
                    <div class="col-6">
                        <div class="produto-estoque ${semEstoque ? 'alerta' : ''}">
                            <i class="bi bi-box"></i> Estoque: ${produto.estoque_atual}
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="produto-preco">R$ ${parseFloat(produto.preco_venda_dinheiro).toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
        
        container.append(html);
    });
}

// ============================================
// ADICIONAR PRODUTO AO CARRINHO
// ============================================
$(document).on('click', '.produto-card', function() {
    const produto = {
        id: parseInt($(this).data('id')),
        codigo: $(this).data('codigo'),
        descricao: $(this).data('descricao'),
        preco: parseFloat($(this).data('preco')),
        preco_debito: parseFloat($(this).data('preco-debito')),
        preco_credito: parseFloat($(this).data('preco-credito')),
        estoque: parseFloat($(this).data('estoque')),
        aplicar_imposto: $(this).data('imposto') === true || $(this).data('imposto') === 'True',
        preco_customizado: $(this).data('customizado') === true || $(this).data('customizado') === 'True',
        precos_credito: $(this).data('precos-credito') || {},
        quantidade: 1,
        semEstoque: parseFloat($(this).data('estoque')) <= 0
    };
    
    // Verificar se j√° existe no carrinho
    const existente = carrinho.find(item => item.id === produto.id);
    
    if (existente) {
        existente.quantidade++;
        
        // Aviso se ultrapassar estoque
        if (existente.quantidade > produto.estoque && produto.estoque > 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Estoque Insuficiente!',
                html: `<strong>Dispon√≠vel: ${produto.estoque} unidades</strong><br>
                       Vendendo: ${existente.quantidade} unidades<br><br>
                       <small>A venda pode continuar, mas o estoque ficar√° negativo.</small>`,
                showConfirmButton: true,
                confirmButtonText: 'Ok, entendi'
            });
        }
    } else {
        carrinho.push(produto);
        
        // Aviso se sem estoque
        if (produto.semEstoque) {
            Swal.fire({
                icon: 'warning',
                title: 'Produto sem estoque!',
                html: `<strong>${produto.descricao}</strong><br><br>
                       Este produto est√° sem estoque.<br>
                       O estoque ficar√° negativo ap√≥s a venda.`,
                timer: 3000,
                showConfirmButton: false
            });
        }
    }
    
    atualizarCarrinho();
    
    // Feedback visual
    $(this).addClass('selected');
    setTimeout(() => $(this).removeClass('selected'), 300);
});

// ============================================
// ATUALIZAR VISUALIZA√á√ÉO DO CARRINHO
// ============================================
function atualizarCarrinho() {
    const container = $('#carrinho-itens');
    container.empty();
    
    if (carrinho.length === 0) {
        container.html(`
            <div class="empty-cart">
                <i class="bi bi-cart-x"></i>
                <p>Carrinho vazio<br>Clique nos produtos para adicionar</p>
            </div>
        `);
        $('#total-geral').text('R$ 0,00');
        $('#total-breakdown').hide();
        $('#info-ajuste').hide();
        return;
    }
    
    let subtotal = 0;
    const formaPagamento = $('#forma-pagamento').val();
    const numeroParcelas = parseInt($('#numero-parcelas').val()) || 1;
    
    carrinho.forEach(item => {
        // Calcular pre√ßo baseado na forma de pagamento
        let precoFinal = item.preco;
        
        if (formaPagamento === 'DB') {
            precoFinal = item.preco_debito || item.preco;
        } else if (formaPagamento === 'CC') {
            precoFinal = item.preco_credito || item.preco;
        } else if (formaPagamento === 'CP') {
            // Cr√©dito parcelado - usar pre√ßo customizado se dispon√≠vel
            if (item.preco_customizado && item.precos_credito[numeroParcelas + 'x']) {
                precoFinal = item.precos_credito[numeroParcelas + 'x'];
            } else {
                precoFinal = item.preco_credito || item.preco;
            }
        }
        
        const itemSubtotal = precoFinal * item.quantidade;
        subtotal += itemSubtotal;
        
        const semEstoqueClass = (item.quantidade > item.estoque) ? 'sem-estoque-warning' : '';
        const alertaEstoque = (item.quantidade > item.estoque) ? 
            `<small class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> Estoque: ${item.estoque}</small>` : '';
        
        let infoParcela = '';
        if (formaPagamento === 'CP') {
            const valorParcela = precoFinal / numeroParcelas;
            infoParcela = `<span class="badge-parcela">${numeroParcelas}x R$ ${valorParcela.toFixed(2)}</span>`;
        }
        
        container.append(`
            <div class="carrinho-item ${semEstoqueClass}" data-id="${item.id}">
                <div style="flex: 1;">
                    <strong>${item.descricao}</strong>${infoParcela}
                    <br>
                    <small class="text-muted">R$ ${precoFinal.toFixed(2)} cada</small>
                    ${alertaEstoque}
                </div>
                <div class="item-qtd-control">
                    <button class="btn btn-sm btn-outline-secondary btn-diminuir" data-id="${item.id}">
                        <i class="bi bi-dash"></i>
                    </button>
                    <span style="min-width: 30px; text-align: center;">${item.quantidade}</span>
                    <button class="btn btn-sm btn-outline-secondary btn-aumentar" data-id="${item.id}">
                        <i class="bi bi-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-remover" data-id="${item.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div style="text-align: right; min-width: 80px;">
                    <strong>R$ ${itemSubtotal.toFixed(2)}</strong>
                </div>
            </div>
        `);
    });
    
    // Calcular ajuste (desconto ou acr√©scimo)
    const resultado = calcularAjuste(subtotal);
    const total = resultado.total;
    const valorAjuste = resultado.valorAjuste;
    
    // Atualizar info do ajuste
    atualizarInfoAjuste(subtotal, valorAjuste);
    
    // Mostrar breakdown se houver ajuste
    if (ajusteAtual.tipo && ajusteAtual.valor > 0) {
        $('#valor-subtotal').text(`R$ ${subtotal.toFixed(2)}`);
        
        const classAjuste = ajusteAtual.tipo === 'desconto' ? 'desconto' : 'acrescimo';
        const sinalAjuste = ajusteAtual.tipo === 'desconto' ? '-' : '+';
        
        $('#label-ajuste').text(`${ajusteAtual.tipo === 'desconto' ? 'Desconto' : 'Acr√©scimo'}:`);
        $('#valor-ajuste-display')
            .removeClass('desconto acrescimo')
            .addClass(classAjuste)
            .text(`${sinalAjuste} R$ ${valorAjuste.toFixed(2)}`);
        
        $('#row-ajuste').show();
        $('#total-breakdown').show();
    } else {
        $('#total-breakdown').hide();
    }
    
    $('#total-geral').text(`R$ ${total.toFixed(2)}`);
}

// ============================================
// CONTROLES DO CARRINHO
// ============================================

// Aumentar quantidade
$(document).on('click', '.btn-aumentar', function() {
    const id = $(this).data('id');
    const item = carrinho.find(i => i.id === id);
    if (item) {
        item.quantidade++;
        
        if (item.quantidade > item.estoque && item.estoque > 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Aten√ß√£o!',
                text: `Estoque: ${item.estoque} | Vendendo: ${item.quantidade}`,
                timer: 2000,
                showConfirmButton: false
            });
        }
        
        atualizarCarrinho();
    }
});

// Diminuir quantidade
$(document).on('click', '.btn-diminuir', function() {
    const id = $(this).data('id');
    const item = carrinho.find(i => i.id === id);
    if (item) {
        item.quantidade--;
        if (item.quantidade <= 0) {
            carrinho = carrinho.filter(i => i.id !== id);
        }
        atualizarCarrinho();
    }
});

// Remover item
$(document).on('click', '.btn-remover', function() {
    const id = $(this).data('id');
    carrinho = carrinho.filter(i => i.id !== id);
    atualizarCarrinho();
});

// Limpar carrinho
$('#btn-limpar').on('click', function() {
    if (carrinho.length === 0) return;
    
    Swal.fire({
        title: 'Limpar carrinho?',
        text: 'Todos os itens ser√£o removidos.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, limpar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            carrinho = [];
            
            // Limpar ajuste tamb√©m
            $('#tipo-ajuste').val('');
            $('#valor-ajuste').val('').prop('disabled', true);
            $('#tipo-valor-ajuste').val('reais').prop('disabled', true);
            ajusteAtual = { tipo: '', valor: 0, tipoValor: 'reais' };
            $('#info-ajuste').hide();
            
            atualizarCarrinho();
        }
    });
});

// Mostrar/ocultar campo de parcelas
$('#forma-pagamento').on('change', function() {
    const parcelasContainer = document.getElementById('parcelas-container');
    if ($(this).val() === 'CP') {
        parcelasContainer.style.display = 'block';
        $('#parcelas-container').slideDown();
    } else {
        parcelasContainer.style.display = 'none';
        $('#parcelas-container').slideUp();
    }
    atualizarCarrinho();
});

// Tamb√©m adicionar listener com JavaScript puro (fallback)
document.getElementById('forma-pagamento').addEventListener('change', function() {
    const parcelasContainer = document.getElementById('parcelas-container');
    if (this.value === 'CP') {
        parcelasContainer.style.display = 'block';
    } else {
        parcelasContainer.style.display = 'none';
    }
    atualizarCarrinho();
});

// Atualizar quando mudar n√∫mero de parcelas
$('#numero-parcelas').on('change', function() {
    atualizarCarrinho();
});

// ============================================
// DESCONTO E ACR√âSCIMO
// ============================================

// Habilitar/desabilitar campos de ajuste
$('#tipo-ajuste').on('change', function() {
    const tipo = $(this).val();
    
    if (tipo) {
        $('#valor-ajuste').prop('disabled', false);
        $('#tipo-valor-ajuste').prop('disabled', false);
        ajusteAtual.tipo = tipo;
    } else {
        $('#valor-ajuste').prop('disabled', true).val('');
        $('#tipo-valor-ajuste').prop('disabled', true);
        ajusteAtual.tipo = '';
        ajusteAtual.valor = 0;
        $('#info-ajuste').hide();
    }
    
    atualizarCarrinho();
});

// Atualizar valor do ajuste
$('#valor-ajuste, #tipo-valor-ajuste').on('input change', function() {
    const valor = parseFloat($('#valor-ajuste').val()) || 0;
    const tipoValor = $('#tipo-valor-ajuste').val();
    
    ajusteAtual.valor = valor;
    ajusteAtual.tipoValor = tipoValor;
    
    atualizarCarrinho();
});

function calcularAjuste(subtotal) {
    if (!ajusteAtual.tipo || ajusteAtual.valor <= 0) {
        return { valorAjuste: 0, total: subtotal };
    }
    
    let valorAjuste = 0;
    
    if (ajusteAtual.tipoValor === 'reais') {
        valorAjuste = ajusteAtual.valor;
    } else {
        // Percentual
        valorAjuste = (subtotal * ajusteAtual.valor) / 100;
    }
    
    let total = subtotal;
    
    if (ajusteAtual.tipo === 'desconto') {
        total = subtotal - valorAjuste;
        if (total < 0) total = 0;
    } else {
        total = subtotal + valorAjuste;
    }
    
    return { valorAjuste, total };
}

function atualizarInfoAjuste(subtotal, valorAjuste) {
    const infoEl = $('#info-ajuste');
    const infoTexto = $('#info-ajuste-texto');
    
    if (!ajusteAtual.tipo || ajusteAtual.valor <= 0) {
        infoEl.hide();
        return;
    }
    
    let texto = '';
    
    if (ajusteAtual.tipoValor === 'reais') {
        texto = `R$ ${ajusteAtual.valor.toFixed(2)}`;
    } else {
        texto = `${ajusteAtual.valor}% de R$ ${subtotal.toFixed(2)} = R$ ${valorAjuste.toFixed(2)}`;
    }
    
    if (ajusteAtual.tipo === 'desconto') {
        texto = `Desconto de ${texto}`;
    } else {
        texto = `Acr√©scimo de ${texto}`;
    }
    
    infoTexto.text(texto);
    infoEl.show();
}

// ============================================
// FINALIZAR VENDA
// ============================================
$('#btn-finalizar').on('click', function() {
    const formaPagamento = $('#forma-pagamento').val();
    const clienteId = $('#cliente-select').val();
    
    if (!formaPagamento) {
        Swal.fire({
            icon: 'warning',
            title: 'Aten√ß√£o!',
            text: 'Selecione a forma de pagamento.',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    if (carrinho.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Carrinho vazio!',
            text: 'Adicione produtos antes de finalizar.',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    // Verificar itens sem estoque
    const itensSemEstoque = carrinho.filter(item => item.quantidade > item.estoque);
    let mensagemEstoque = '';
    
    if (itensSemEstoque.length > 0) {
        mensagemEstoque = `<div class="alert alert-warning mt-2">
            <strong>‚ö†Ô∏è Produtos com estoque insuficiente:</strong><br>`;
        itensSemEstoque.forEach(item => {
            mensagemEstoque += `‚Ä¢ ${item.descricao}: Vendendo ${item.quantidade} | Estoque: ${item.estoque}<br>`;
        });
        mensagemEstoque += `<small>O estoque ficar√° negativo.</small></div>`;
    }
    
    const clienteInfo = clienteId ? $('#cliente-select option:selected').text() : 'N√£o informado';
    
    // Calcular subtotal e total com ajuste
    let subtotal = 0;
    const formaPagamentoVal = $('#forma-pagamento').val();
    const numeroParcelas = parseInt($('#numero-parcelas').val()) || 1;
    
    carrinho.forEach(item => {
        let precoFinal = item.preco;
        
        if (formaPagamentoVal === 'DB') {
            precoFinal = item.preco_debito || item.preco;
        } else if (formaPagamentoVal === 'CC') {
            precoFinal = item.preco_credito || item.preco;
        } else if (formaPagamentoVal === 'CP') {
            if (item.preco_customizado && item.precos_credito[numeroParcelas + 'x']) {
                precoFinal = item.precos_credito[numeroParcelas + 'x'];
            } else {
                precoFinal = item.preco_credito || item.preco;
            }
        }
        
        subtotal += precoFinal * item.quantidade;
    });
    
    const resultado = calcularAjuste(subtotal);
    const totalVenda = resultado.total;
    const valorAjuste = resultado.valorAjuste;
    
    const formaPagamentoTexto = $('#forma-pagamento option:selected').text();
    
    let infoAdicional = '';
    if ($('#forma-pagamento').val() === 'CP') {
        const parcelas = $('#numero-parcelas').val();
        const valorParcela = totalVenda / parcelas;
        infoAdicional = `<br><strong>Parcelas:</strong> ${parcelas}x de R$ ${valorParcela.toFixed(2)}`;
    }
    
    // Informa√ß√£o de desconto/acr√©scimo
    let infoAjuste = '';
    if (ajusteAtual.tipo && ajusteAtual.valor > 0) {
        const tipoTexto = ajusteAtual.tipo === 'desconto' ? 'Desconto' : 'Acr√©scimo';
        const sinal = ajusteAtual.tipo === 'desconto' ? '-' : '+';
        infoAjuste = `<br><strong>Subtotal:</strong> R$ ${subtotal.toFixed(2)}<br>
                      <strong>${tipoTexto}:</strong> ${sinal} R$ ${valorAjuste.toFixed(2)}`;
    }
    
    // Confirma√ß√£o final
    Swal.fire({
        title: 'Confirmar Venda?',
        html: `
            <div style="text-align: left;">
                <strong>Cliente:</strong> ${clienteInfo}<br>
                <strong>Forma de Pagamento:</strong> ${formaPagamentoTexto}${infoAdicional}<br>
                <strong>Total de itens:</strong> ${carrinho.length}${infoAjuste}<br>
                <strong>Valor Total:</strong> R$ ${totalVenda.toFixed(2)}
                ${mensagemEstoque}
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Confirmar Venda',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#198754'
    }).then((result) => {
        if (result.isConfirmed) {
            // Aqui voc√™ faria a chamada AJAX para salvar a venda
            // Por enquanto, apenas simula sucesso
            
            Swal.fire({
                icon: 'success',
                title: 'Venda Realizada!',
                text: 'A venda foi registrada com sucesso.',
                timer: 2000,
                showConfirmButton: false
            });
            
            setTimeout(() => {
                carrinho = [];
                atualizarCarrinho();
                $('#cliente-select').val('');
                $('#forma-pagamento').val('DI');
                $('#parcelas-container').hide();
                
                // Limpar ajuste
                $('#tipo-ajuste').val('');
                $('#valor-ajuste').val('').prop('disabled', true);
                $('#tipo-valor-ajuste').val('reais').prop('disabled', true);
                ajusteAtual = { tipo: '', valor: 0, tipoValor: 'reais' };
                $('#info-ajuste').hide();
                
                $('#search-produto').val('').focus();
                ultimaBusca = '';
            }, 2000);
        }
    });
});

// ============================================
// ATALHOS DE TECLADO
// ============================================
$(document).on('keydown', function(e) {
    // F2 - Focar em busca
    if (e.key === 'F2') {
        e.preventDefault();
        $('#search-produto').focus().select();
    }
    
    // F3 - Focar em cliente
    if (e.key === 'F3') {
        e.preventDefault();
        $('#cliente-select').focus();
    }
    
    // F4 - Finalizar venda
    if (e.key === 'F4') {
        e.preventDefault();
        $('#btn-finalizar').click();
    }
});

// Focar no campo de busca ao carregar
$(document).ready(function() {
    $('#search-produto').focus();
});
</script>

<!-- SweetAlert2 para alertas bonitos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}