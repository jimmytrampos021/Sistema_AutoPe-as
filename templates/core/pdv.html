{% extends 'base.html' %}

{% block title %}PDV - Sistema Autope√ßas{% endblock %}

{% block page_title %}Ponto de Venda (PDV){% endblock %}

{% block extra_css %}
<style>
    .pdv-container {
        display: grid;
        grid-template-columns: 1fr 450px;
        gap: 20px;
        height: calc(100vh - 180px);
    }
    
    .produtos-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        overflow-y: auto;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .carrinho-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .produto-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
    }
    
    .produto-card:hover {
        border-color: #0d6efd;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(13,110,253,0.2);
    }
    
    .produto-card.selected {
        border-color: #0d6efd;
        background: #e7f1ff;
    }
    
    .produto-card.sem-estoque {
        border-color: #dc3545;
        opacity: 0.7;
    }
    
    .produto-card.sem-estoque:hover {
        border-color: #dc3545;
        opacity: 1;
    }
    
    .produto-codigo {
        font-size: 12px;
        color: #6c757d;
        font-weight: bold;
    }
    
    .produto-nome {
        font-size: 16px;
        font-weight: 600;
        margin: 5px 0;
    }
    
    .produto-estoque {
        font-size: 13px;
        color: #6c757d;
    }
    
    .produto-estoque.alerta {
        color: #dc3545;
        font-weight: bold;
    }
    
    .produto-preco {
        font-size: 20px;
        color: #198754;
        font-weight: bold;
        margin-top: 8px;
    }
    
    .carrinho-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 10px;
    }
    
    .carrinho-item:last-child {
        border-bottom: none;
    }
    
    .carrinho-item.sem-estoque-warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
    }
    
    .item-qtd-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .item-qtd-control button {
        width: 30px;
        height: 30px;
        padding: 0;
        border-radius: 50%;
    }
    
    .carrinho-total {
        margin-top: auto;
        padding-top: 20px;
        border-top: 3px solid #0d6efd;
    }
    
    .total-valor {
        font-size: 32px;
        font-weight: bold;
        color: #0d6efd;
        text-align: center;
        margin: 15px 0;
    }
    
    .search-box {
        position: sticky;
        top: 0;
        background: white;
        padding-bottom: 15px;
        z-index: 10;
    }
    
    body.dark-mode .search-box {
        background: #2d2d2d;
    }
    
    .search-counter {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .produto-card.selected {
        animation: pulseGreen 0.3s ease;
    }
    
    @keyframes pulseGreen {
        0%, 100% { transform: scale(1); border-color: #e9ecef; }
        50% { transform: scale(1.05); border-color: #198754; background-color: #d1e7dd; }
    }
    
    #search-produto:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        border-color: #0d6efd;
    }
    
    .empty-cart {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-cart i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .badge-sem-estoque {
        background-color: #dc3545;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 5px;
    }
    
    /* Loading spinner */
    .loading-spinner {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }
    
    /* Modo Escuro */
    body.dark-mode .pdv-container {
        color: #e0e0e0;
    }
    
    body.dark-mode .produtos-section,
    body.dark-mode .carrinho-section {
        background: #2d2d2d;
        color: #e0e0e0;
    }
    
    body.dark-mode .produto-card {
        background: #1a1a1a;
        border-color: #444;
        color: #e0e0e0;
    }
    
    body.dark-mode .produto-card:hover {
        border-color: #0d6efd;
        background: #2a2a2a;
    }
    
    body.dark-mode .produto-card.selected {
        background: #1a3a5a;
        border-color: #0d6efd;
    }
    
    body.dark-mode .produto-codigo,
    body.dark-mode .produto-estoque {
        color: #999;
    }
    
    body.dark-mode .produto-nome {
        color: #e0e0e0;
    }
    
    body.dark-mode .carrinho-item {
        border-bottom-color: #444;
    }
    
    body.dark-mode .empty-cart {
        color: #999;
    }
    
    body.dark-mode .form-select,
    body.dark-mode .form-control {
        background: #1a1a1a;
        border-color: #444;
        color: #e0e0e0;
    }
    
    body.dark-mode .form-select:focus,
    body.dark-mode .form-control:focus {
        background: #2a2a2a;
        border-color: #0d6efd;
        color: #e0e0e0;
    }
    
    body.dark-mode .search-counter,
    body.dark-mode .loading-spinner {
        color: #999;
    }
    
    /* Badge de parcelas */
    .badge-parcela {
        background: #0d6efd;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-left: 5px;
    }
    
    /* Info de desconto/acr√©scimo */
    #info-ajuste {
        background: #e7f1ff;
        padding: 5px 8px;
        border-radius: 5px;
        border-left: 3px solid #0d6efd;
    }
    
    body.dark-mode #info-ajuste {
        background: #1a3a5a;
        border-left-color: #4a90e2;
        color: #a0c4ff;
    }
    
    .total-breakdown {
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .total-breakdown .row {
        padding: 3px 0;
    }
    
    .total-breakdown .label {
        color: #6c757d;
    }
    
    .total-breakdown .value {
        font-weight: 600;
    }
    
    .total-breakdown .desconto {
        color: #198754;
    }
    
    .total-breakdown .acrescimo {
        color: #dc3545;
    }
    
    body.dark-mode .total-breakdown .label {
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="pdv-container">
    <!-- Se√ß√£o de Produtos -->
    <div class="produtos-section">
        <div class="search-box">
            <h4><i class="bi bi-box-seam"></i> Produtos</h4>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="search-produto" class="form-control form-control-lg" 
                       placeholder="Digite para buscar (m√≠nimo 2 caracteres)..." 
                       autocomplete="off">
            </div>
            <div class="search-counter" id="search-counter">
                Mostrando {{ produtos|length }} de {{ total_produtos }} produtos
            </div>
        </div>
        
        <div id="lista-produtos" class="mt-3">
            {% for produto in produtos %}
            <div class="produto-card {% if produto.estoque_atual <= 0 %}sem-estoque{% endif %}" 
                 data-id="{{ produto.id }}" 
                 data-codigo="{{ produto.codigo }}"
                 data-codigo-barras="{% if produto.codigo_barras %}{{ produto.codigo_barras }}{% endif %}"
                 data-descricao="{{ produto.descricao }}" 
                 data-preco="{{ produto.preco_venda_dinheiro }}"
                 data-estoque="{{ produto.estoque_atual }}">
                <div class="produto-codigo">
                    {{ produto.codigo }}
                    {% if produto.codigo_barras %} | <small>{{ produto.codigo_barras }}</small>{% endif %}
                    {% if produto.estoque_atual <= 0 %}
                        <span class="badge-sem-estoque">SEM ESTOQUE</span>
                    {% endif %}
                </div>
                <div class="produto-nome">{{ produto.descricao }}</div>
                <div class="row">
                    <div class="col-6">
                        <div class="produto-estoque {% if produto.estoque_atual <= 0 %}alerta{% endif %}">
                            <i class="bi bi-box"></i> Estoque: {{ produto.estoque_atual }}
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="produto-preco">R$ {{ produto.preco_venda_dinheiro }}</div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted p-5">
                <i class="bi bi-inbox" style="font-size: 48px;"></i>
                <p>Nenhum produto dispon√≠vel</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Se√ß√£o do Carrinho -->
    <div class="carrinho-section">
        <h4><i class="bi bi-cart3"></i> Carrinho</h4>
        
        <!-- Cliente -->
        <div class="mb-3">
            <label class="form-label">Cliente <small class="text-muted">(opcional)</small></label>
            <select id="cliente-select" class="form-select">
                <option value="">N√£o informado</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nome }} - {{ cliente.cpf_cnpj }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Forma de Pagamento -->
        <div class="mb-3">
            <label class="form-label">Forma de Pagamento</label>
            <select id="forma-pagamento" class="form-select">
                <option value="DI">üíµ Dinheiro/PIX</option>
                <option value="DB">üí≥ D√©bito</option>
                <option value="CC">üí≥ Cr√©dito √† Vista</option>
                <option value="CP">üí≥ Cr√©dito Parcelado</option>
                <option value="CR">üìã Credi√°rio/Fiado</option>
            </select>
        </div>
        
        <!-- Parcelas (aparece apenas se Cr√©dito Parcelado) -->
        <div id="parcelas-container" class="mb-3" style="display: none;">
            <label class="form-label">N√∫mero de Parcelas</label>
            <select id="numero-parcelas" class="form-select">
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="5">5x</option>
                <option value="6">6x</option>
                <option value="7">7x</option>
                <option value="8">8x</option>
                <option value="9">9x</option>
                <option value="10">10x</option>
                <option value="11">11x</option>
                <option value="12">12x</option>
            </select>
        </div>
        <!-- Parcelas Credi√°rio -->
        <div id="parcelas-crediario-container" style="display: none;" class="mb-3">
            <label class="form-label">Parcelas do Credi√°rio</label>
            <select id="parcelas-crediario" class="form-select">
                <option value="1">1x (√† vista)</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="5">5x</option>
                <option value="6">6x</option>
                <option value="7">7x</option>
                <option value="8">8x</option>
                <option value="9">9x</option>
                <option value="10">10x</option>
                <option value="11">11x</option>
                <option value="12">12x</option>
            </select>
            <small class="text-muted">Parcelas mensais no fiado</small>
        </div>
        
        <!-- Desconto/Acr√©scimo -->
        <div class="mb-3">
            <label class="form-label">üí∞ Desconto/Acr√©scimo</label>
            <div class="row g-2">
                <div class="col-5">
                    <select id="tipo-ajuste" class="form-select form-select-sm">
                        <option value="">Nenhum</option>
                        <option value="desconto">Desconto</option>
                        <option value="acrescimo">Acr√©scimo</option>
                    </select>
                </div>
                <div class="col-4">
                    <input type="number" id="valor-ajuste" class="form-control form-control-sm" 
                           placeholder="0.00" step="0.01" min="0" disabled>
                </div>
                <div class="col-3">
                    <select id="tipo-valor-ajuste" class="form-select form-select-sm" disabled>
                        <option value="reais">R$</option>
                        <option value="percent">%</option>
                    </select>
                </div>
            </div>
            <div id="info-ajuste" class="mt-1" style="font-size: 11px; color: #6c757d; display: none;">
                <i class="bi bi-info-circle"></i> <span id="info-ajuste-texto"></span>
            </div>
        </div>
        
        <!-- Itens do Carrinho -->
        <div id="carrinho-itens" style="flex: 1; overflow-y: auto; max-height: 250px;">
            <div class="empty-cart">
                <i class="bi bi-cart-x"></i>
                <p>Carrinho vazio<br>Clique nos produtos para adicionar</p>
            </div>
        </div>
        
        <!-- Total e Finaliza√ß√£o -->
        <div class="carrinho-total">
            <!-- Detalhamento do Total -->
            <div class="total-breakdown" id="total-breakdown" style="display: none;">
                <div class="row">
                    <div class="col-6 label">Subtotal:</div>
                    <div class="col-6 text-end value" id="valor-subtotal">R$ 0,00</div>
                </div>
                <div class="row" id="row-ajuste" style="display: none;">
                    <div class="col-6 label" id="label-ajuste">Desconto:</div>
                    <div class="col-6 text-end value" id="valor-ajuste-display">R$ 0,00</div>
                </div>
                <hr style="margin: 8px 0;">
            </div>
            
            <div class="total-valor" id="total-geral">R$ 0,00</div>
            
            <div class="d-grid gap-2">
                <button id="btn-finalizar" class="btn btn-success btn-lg">
                    <i class="bi bi-check-circle"></i> Finalizar Venda (F4)
                </button>
                <button id="btn-limpar" class="btn btn-outline-danger">
                    <i class="bi bi-x-circle"></i> Limpar Carrinho
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    
let carrinho = [];
let buscaTimeout = null;
let ultimaBusca = '';
let ajusteAtual = {
    tipo: '',      // 'desconto' ou 'acrescimo'
    valor: 0,      // valor num√©rico
    tipoValor: 'reais'  // 'reais' ou 'percent'
};

// ============================================
// VARI√ÅVEIS GLOBAIS - SISTEMA DE CASCO
// ============================================
let amperagensBateria = []; // Cache das amperagens
let cascoAtual = {
    produtoId: null,
    produtoInfo: null,
    amperagemVendidaId: null,
    trouxeCasco: null,
    amperagemCascoId: null,
    valorCascoVendido: 0,
    valorCascoRecebido: 0,
    diferenca: 0
};

// ============================================
// CARREGAR AMPERAGENS AO INICIAR
// ============================================
function carregarAmperagens() {
    fetch('/api/baterias/amperagens/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                amperagensBateria = data.amperagens;
                
                // Popular select do modal
                const select = $('#casco-amperagem-select');
                select.html('<option value="">Selecione a amperagem...</option>');
                
                data.amperagens.forEach(amp => {
                    select.append(`<option value="${amp.id}" data-valor="${amp.valor_casco_troca}">
                        ${amp.amperagem} ${amp.nome_tecnico ? '(' + amp.nome_tecnico + ')' : ''} - R$ ${amp.valor_casco_troca.toFixed(2)}
                    </option>`);
                });
            }
        })
        .catch(error => console.error('Erro ao carregar amperagens:', error));
}

// ============================================
// BUSCA AJAX DE PRODUTOS
// ============================================
$('#search-produto').on('input', function() {
    const query = $(this).val().trim();
    
    // Limpar timeout anterior
    if (buscaTimeout) {
        clearTimeout(buscaTimeout);
    }
    
    // Se busca vazia, mostrar produtos iniciais
    if (query.length === 0) {
        $('#search-counter').text('Mostrando produtos recentes');
        return;
    }
    
    // Aguardar 300ms antes de buscar (debounce)
    buscaTimeout = setTimeout(function() {
        if (query.length < 2) {
            $('#search-counter').html('<span class="text-muted">Digite pelo menos 2 caracteres</span>');
            return;
        }
        
        // Evitar buscar a mesma coisa
        if (query === ultimaBusca) {
            return;
        }
        
        ultimaBusca = query;
        buscarProdutos(query);
    }, 300);
});

function buscarProdutos(query) {
    // Mostrar loading
    $('#lista-produtos').html(`
        <div class="loading-spinner">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Buscando...</span>
            </div>
            <p class="mt-2">Buscando produtos...</p>
        </div>
    `);
    
    $('#search-counter').html('<span class="spinner-border spinner-border-sm me-2"></span>Buscando...');
    
    // Fazer requisi√ß√£o AJAX
    $.ajax({
        url: '{% url "api_buscar_produtos_pdv" %}',
        method: 'GET',
        data: { q: query },
        success: function(response) {
            renderizarProdutos(response.produtos);
            $('#search-counter').text(`${response.total} produto(s) encontrado(s)`);
        },
        error: function(xhr, status, error) {
            console.error('Erro na busca:', error);
            $('#lista-produtos').html(`
                <div class="text-center text-danger p-5">
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
                    <p>Erro ao buscar produtos</p>
                    <small>${error}</small>
                </div>
            `);
            $('#search-counter').html('<span class="text-danger">Erro na busca</span>');
        }
    });
}

function renderizarProdutos(produtos) {
    const container = $('#lista-produtos');
    container.empty();
    
    if (produtos.length === 0) {
        container.html(`
            <div class="text-center text-muted p-5">
                <i class="bi bi-inbox" style="font-size: 48px;"></i>
                <p>Nenhum produto encontrado</p>
            </div>
        `);
        return;
    }
    
    produtos.forEach(produto => {
        const semEstoque = produto.estoque_atual <= 0;
        const badgeSemEstoque = semEstoque ? '<span class="badge-sem-estoque">SEM ESTOQUE</span>' : '';
        const codigoBarras = produto.codigo_barras ? ` | <small>${produto.codigo_barras}</small>` : '';
        
        // Badge de bateria
        const isBateria = produto.amperagem_bateria_id && produto.amperagem_bateria_id > 0;
        const badgeBateria = isBateria ? `<span class="badge-bateria"><i class="bi bi-battery-charging"></i> ${produto.amperagem_nome || 'Bateria'}</span>` : '';
        
        const html = `
            <div class="produto-card ${semEstoque ? 'sem-estoque' : ''}" 
                 data-id="${produto.id}" 
                 data-codigo="${produto.codigo}"
                 data-codigo-barras="${produto.codigo_barras || ''}"
                 data-descricao="${produto.descricao}" 
                 data-preco="${produto.preco_venda_dinheiro}"
                 data-preco-debito="${produto.preco_venda_debito || produto.preco_venda_dinheiro}"
                 data-preco-credito="${produto.preco_venda_credito || produto.preco_venda_dinheiro}"
                 data-estoque="${produto.estoque_atual}"
                 data-imposto="${produto.aplicar_imposto_4}"
                 data-customizado="${produto.preco_customizado_cartao}"
                 data-precos-credito='${JSON.stringify(produto.precos_credito || {})}'
                 data-is-bateria="${isBateria}"
                 data-amperagem-id="${produto.amperagem_bateria_id || ''}"
                 data-amperagem-nome="${produto.amperagem_nome || ''}"
                 data-valor-casco="${produto.valor_casco || 0}">
                <div class="produto-codigo">
                    ${produto.codigo}${codigoBarras}${badgeSemEstoque}${badgeBateria}
                </div>
                <div class="produto-nome">${produto.descricao}</div>
                <div class="row">
                    <div class="col-6">
                        <div class="produto-estoque ${semEstoque ? 'alerta' : ''}">
                            <i class="bi bi-box"></i> Estoque: ${produto.estoque_atual}
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <div class="produto-preco">R$ ${parseFloat(produto.preco_venda_dinheiro).toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
        
        container.append(html);
    });
}

// ============================================
// SISTEMA DE CASCO - MODAL
// ============================================

// Abrir modal de casco
function abrirModalCasco(produto) {
    // Resetar estado
    cascoAtual = {
        produtoId: produto.id,
        produtoInfo: produto,
        amperagemVendidaId: produto.amperagem_id,
        trouxeCasco: null,
        amperagemCascoId: null,
        valorCascoVendido: produto.valor_casco || 0,
        valorCascoRecebido: 0,
        diferenca: 0
    };
    
    // Preencher informa√ß√µes no modal
    $('#casco-bateria-nome').text(produto.descricao);
    $('#casco-amperagem-vendida').text(produto.amperagem_nome || 'N/A');
    $('#casco-valor-vendido').text(cascoAtual.valorCascoVendido.toFixed(2));
    
    // Resetar sele√ß√µes
    $('.btn-casco-opcao').removeClass('active');
    $('#casco-amperagem-container').hide();
    $('#casco-amperagem-select').val('');
    $('#casco-resultado').hide();
    $('#btn-confirmar-casco').prop('disabled', true);
    
    // Pr√©-selecionar a mesma amperagem no select
    if (produto.amperagem_id) {
        $('#casco-amperagem-select').val(produto.amperagem_id);
    }
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalCasco'));
    modal.show();
}

// Clique nos bot√µes SIM/N√ÉO
$(document).on('click', '.btn-casco-opcao', function() {
    const opcao = $(this).data('opcao');
    
    // Marcar como ativo
    $('.btn-casco-opcao').removeClass('active');
    $(this).addClass('active');
    
    cascoAtual.trouxeCasco = (opcao === 'sim');
    
    if (opcao === 'sim') {
        // Mostrar sele√ß√£o de amperagem
        $('#casco-amperagem-container').slideDown();
        
        // Se j√° tem amperagem selecionada, calcular
        if ($('#casco-amperagem-select').val()) {
            calcularDiferencaCasco();
        }
    } else {
        // Esconder sele√ß√£o e calcular direto (sem casco)
        $('#casco-amperagem-container').slideUp();
        cascoAtual.amperagemCascoId = null;
        cascoAtual.valorCascoRecebido = 0;
        calcularDiferencaCasco();
    }
});

// Mudan√ßa na sele√ß√£o de amperagem
$('#casco-amperagem-select').on('change', function() {
    if (cascoAtual.trouxeCasco) {
        calcularDiferencaCasco();
    }
});

// Calcular diferen√ßa de casco
function calcularDiferencaCasco() {
    const amperagemVendidaId = cascoAtual.amperagemVendidaId;
    const trouxeCasco = cascoAtual.trouxeCasco;
    const amperagemCascoId = $('#casco-amperagem-select').val();
    
    let url = `/api/baterias/calcular-casco/?amperagem_vendida_id=${amperagemVendidaId}&trouxe_casco=${trouxeCasco}`;
    
    if (trouxeCasco && amperagemCascoId) {
        url += `&amperagem_casco_id=${amperagemCascoId}`;
        cascoAtual.amperagemCascoId = amperagemCascoId;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cascoAtual.valorCascoVendido = data.valor_casco_vendido;
                cascoAtual.valorCascoRecebido = data.valor_casco_recebido;
                cascoAtual.diferenca = data.diferenca;
                
                // Mostrar resultado
                const resultadoEl = $('#casco-resultado');
                const textoEl = $('#casco-resultado-texto');
                
                resultadoEl.removeClass('alert-success alert-warning alert-danger');
                
                if (data.diferenca > 0) {
                    // Acr√©scimo
                    resultadoEl.addClass('alert-danger');
                    textoEl.html(`
                        <strong><i class="bi bi-arrow-up-circle"></i> ACR√âSCIMO</strong><br>
                        Cliente paga <strong>+ R$ ${data.diferenca.toFixed(2)}</strong><br>
                        <small>${data.mensagem}</small>
                    `);
                } else if (data.diferenca < 0) {
                    // Desconto
                    resultadoEl.addClass('alert-success');
                    textoEl.html(`
                        <strong><i class="bi bi-arrow-down-circle"></i> DESCONTO</strong><br>
                        Cliente recebe <strong>- R$ ${Math.abs(data.diferenca).toFixed(2)}</strong><br>
                        <small>${data.mensagem}</small>
                    `);
                } else {
                    // Troca normal
                    resultadoEl.addClass('alert-success');
                    textoEl.html(`
                        <strong><i class="bi bi-check-circle"></i> TROCA NORMAL</strong><br>
                        Sem acr√©scimo ou desconto<br>
                        <small>${data.mensagem}</small>
                    `);
                }
                
                resultadoEl.slideDown();
                $('#btn-confirmar-casco').prop('disabled', false);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro!',
                    text: data.error || 'Erro ao calcular casco'
                });
            }
        })
        .catch(error => {
            console.error('Erro ao calcular casco:', error);
        });
}

// Confirmar e adicionar bateria ao carrinho
$('#btn-confirmar-casco').on('click', function() {
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('modalCasco')).hide();
    
    // Adicionar ao carrinho com informa√ß√µes do casco
    adicionarBateriaAoCarrinho(cascoAtual);
});

// Adicionar bateria ao carrinho (com info de casco)
function adicionarBateriaAoCarrinho(infoCasco) {
    const produto = infoCasco.produtoInfo;
    
    // Verificar se j√° existe no carrinho
    const itemExistente = carrinho.find(item => item.id === produto.id);
    
    // Calcular pre√ßo com ajuste de casco
    let precoBase = parseFloat(produto.preco);
    let precoFinal = precoBase + infoCasco.diferenca;
    
    let precoDebitoFinal = parseFloat(produto.preco_debito || produto.preco) + infoCasco.diferenca;
    let precoCreditoFinal = parseFloat(produto.preco_credito || produto.preco) + infoCasco.diferenca;
    
    if (itemExistente) {
        // Se j√° existe, perguntar se quer adicionar outra unidade
        Swal.fire({
            icon: 'question',
            title: 'Bateria j√° no carrinho',
            text: 'Deseja adicionar mais uma unidade? (Nova verifica√ß√£o de casco ser√° necess√°ria)',
            showCancelButton: true,
            confirmButtonText: 'Sim, adicionar',
            cancelButtonText: 'N√£o'
        }).then((result) => {
            if (result.isConfirmed) {
                itemExistente.quantidade += 1;
                itemExistente.total = itemExistente.quantidade * itemExistente.preco;
                atualizarCarrinho();
            }
        });
    } else {
        // Adicionar novo item
        carrinho.push({
            id: produto.id,
            codigo: produto.codigo,
            descricao: produto.descricao,
            preco: precoFinal,
            preco_original: precoBase,
            preco_debito: precoDebitoFinal,
            preco_credito: precoCreditoFinal,
            preco_customizado: produto.preco_customizado,
            precos_credito: produto.precos_credito || {},
            quantidade: 1,
            total: precoFinal,
            estoque: produto.estoque,
            // Informa√ß√µes espec√≠ficas de bateria
            is_bateria: true,
            info_casco: {
                trouxe_casco: infoCasco.trouxeCasco,
                amperagem_vendida_id: infoCasco.amperagemVendidaId,
                amperagem_casco_id: infoCasco.amperagemCascoId,
                valor_casco_vendido: infoCasco.valorCascoVendido,
                valor_casco_recebido: infoCasco.valorCascoRecebido,
                diferenca: infoCasco.diferenca
            }
        });
        
        atualizarCarrinho();
        
        // Feedback visual
        let mensagem = '';
        if (infoCasco.trouxeCasco) {
            if (infoCasco.diferenca > 0) {
                mensagem = `Bateria adicionada COM troca (+R$ ${infoCasco.diferenca.toFixed(2)} diferen√ßa)`;
            } else if (infoCasco.diferenca < 0) {
                mensagem = `Bateria adicionada COM troca (-R$ ${Math.abs(infoCasco.diferenca).toFixed(2)} desconto)`;
            } else {
                mensagem = `Bateria adicionada COM troca (mesmo valor)`;
            }
        } else {
            mensagem = `Bateria adicionada SEM troca (+R$ ${infoCasco.diferenca.toFixed(2)})`;
        }
        
        Swal.fire({
            icon: 'success',
            title: 'Bateria Adicionada!',
            text: mensagem,
            timer: 2500,
            showConfirmButton: false
        });
    }
}

// ============================================
// ADICIONAR PRODUTO AO CARRINHO
// ============================================
$(document).on('click', '.produto-card', function() {
    const isBateria = $(this).data('is-bateria') === true || $(this).data('is-bateria') === 'true';
    
    const produto = {
        id: parseInt($(this).data('id')),
        codigo: $(this).data('codigo'),
        descricao: $(this).data('descricao'),
        preco: parseFloat($(this).data('preco')),
        preco_debito: parseFloat($(this).data('preco-debito')),
        preco_credito: parseFloat($(this).data('preco-credito')),
        estoque: parseFloat($(this).data('estoque')),
        aplicar_imposto: $(this).data('imposto') === true || $(this).data('imposto') === 'True',
        preco_customizado: $(this).data('customizado') === true || $(this).data('customizado') === 'True',
        precos_credito: $(this).data('precos-credito') || {},
        quantidade: 1,
        semEstoque: parseFloat($(this).data('estoque')) <= 0,
        // Dados de bateria
        is_bateria: isBateria,
        amperagem_id: $(this).data('amperagem-id') || null,
        amperagem_nome: $(this).data('amperagem-nome') || null,
        valor_casco: parseFloat($(this).data('valor-casco')) || 0
    };
    
    // Se √© bateria, abrir modal de casco
    if (isBateria && produto.amperagem_id) {
        abrirModalCasco(produto);
        return; // N√£o adiciona direto, espera confirma√ß√£o do modal
    }
    
    // Produto normal - adicionar diretamente
    adicionarProdutoNormal(produto);
});

// Adicionar produto normal (n√£o bateria)
function adicionarProdutoNormal(produto) {
    // Verificar se j√° existe no carrinho
    const existente = carrinho.find(item => item.id === produto.id);
    
    if (existente) {
        existente.quantidade++;
        
        // Aviso se ultrapassar estoque
        if (existente.quantidade > produto.estoque && produto.estoque > 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Estoque Insuficiente!',
                html: `<strong>Dispon√≠vel: ${produto.estoque} unidades</strong><br>
                       Vendendo: ${existente.quantidade} unidades<br><br>
                       <small>A venda pode continuar, mas o estoque ficar√° negativo.</small>`,
                showConfirmButton: true,
                confirmButtonText: 'Ok, entendi'
            });
        }
    } else {
        carrinho.push(produto);
        
        // Aviso se sem estoque
        if (produto.semEstoque) {
            Swal.fire({
                icon: 'warning',
                title: 'Produto sem estoque!',
                html: `<strong>${produto.descricao}</strong><br><br>
                       Este produto est√° sem estoque.<br>
                       O estoque ficar√° negativo ap√≥s a venda.`,
                timer: 3000,
                showConfirmButton: false
            });
        }
    }
    
    atualizarCarrinho();
    
    // Feedback visual
    $(`.produto-card[data-id="${produto.id}"]`).addClass('selected');
    setTimeout(() => $(`.produto-card[data-id="${produto.id}"]`).removeClass('selected'), 300);
}

// ============================================
// ATUALIZAR VISUALIZA√á√ÉO DO CARRINHO
// ============================================
function atualizarCarrinho() {
    const container = $('#carrinho-itens');
    container.empty();
    
    if (carrinho.length === 0) {
        container.html(`
            <div class="empty-cart">
                <i class="bi bi-cart-x"></i>
                <p>Carrinho vazio<br>Clique nos produtos para adicionar</p>
            </div>
        `);
        $('#total-geral').text('R$ 0,00');
        $('#total-breakdown').hide();
        $('#info-ajuste').hide();
        return;
    }
    
    let subtotal = 0;
    const formaPagamento = $('#forma-pagamento').val();
    const numeroParcelas = parseInt($('#numero-parcelas').val()) || 1;
    
    carrinho.forEach(item => {
        // Calcular pre√ßo baseado na forma de pagamento
        let precoFinal = item.preco;
        
        if (formaPagamento === 'DB') {
            precoFinal = item.preco_debito || item.preco;
        } else if (formaPagamento === 'CC') {
            precoFinal = item.preco_credito || item.preco;
        } else if (formaPagamento === 'CP') {
            // Cr√©dito parcelado - usar pre√ßo customizado se dispon√≠vel
            if (item.preco_customizado && item.precos_credito[numeroParcelas + 'x']) {
                precoFinal = item.precos_credito[numeroParcelas + 'x'];
            } else {
                precoFinal = item.preco_credito || item.preco;
            }
        }
        
        const itemSubtotal = precoFinal * item.quantidade;
        subtotal += itemSubtotal;
        
        const semEstoqueClass = (item.quantidade > item.estoque) ? 'sem-estoque-warning' : '';
        const alertaEstoque = (item.quantidade > item.estoque) ? 
            `<small class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> Estoque: ${item.estoque}</small>` : '';
        
        let infoParcela = '';
        if (formaPagamento === 'CP') {
            const valorParcela = precoFinal / numeroParcelas;
            infoParcela = `<span class="badge-parcela">${numeroParcelas}x R$ ${valorParcela.toFixed(2)}</span>`;
        }
        
        // Badge de bateria com info de casco
        let badgeCasco = '';
        if (item.is_bateria && item.info_casco) {
            if (item.info_casco.trouxe_casco) {
                if (item.info_casco.diferenca > 0) {
                    badgeCasco = `<span class="badge-bateria" style="background:#ffc107;color:#000;"><i class="bi bi-battery-charging"></i> +R$${item.info_casco.diferenca.toFixed(2)}</span>`;
                } else if (item.info_casco.diferenca < 0) {
                    badgeCasco = `<span class="badge-bateria com-troca"><i class="bi bi-battery-charging"></i> -R$${Math.abs(item.info_casco.diferenca).toFixed(2)}</span>`;
                } else {
                    badgeCasco = `<span class="badge-bateria com-troca"><i class="bi bi-battery-charging"></i> Troca</span>`;
                }
            } else {
                badgeCasco = `<span class="badge-bateria sem-troca"><i class="bi bi-battery-charging"></i> Sem troca +R$${item.info_casco.diferenca.toFixed(2)}</span>`;
            }
        }
        
        container.append(`
            <div class="carrinho-item ${semEstoqueClass}" data-id="${item.id}">
                <div style="flex: 1;">
                    <strong>${item.descricao}</strong>${infoParcela}${badgeCasco}
                    <br>
                    <small class="text-muted">R$ ${precoFinal.toFixed(2)} cada</small>
                    ${alertaEstoque}
                </div>
                <div class="item-qtd-control">
                    <button class="btn btn-sm btn-outline-secondary btn-diminuir" data-id="${item.id}">
                        <i class="bi bi-dash"></i>
                    </button>
                    <span style="min-width: 30px; text-align: center;">${item.quantidade}</span>
                    <button class="btn btn-sm btn-outline-secondary btn-aumentar" data-id="${item.id}">
                        <i class="bi bi-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-remover" data-id="${item.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div style="text-align: right; min-width: 80px;">
                    <strong>R$ ${itemSubtotal.toFixed(2)}</strong>
                </div>
            </div>
        `);
    });
    
    // Calcular ajuste (desconto ou acr√©scimo)
    const resultado = calcularAjuste(subtotal);
    const total = resultado.total;
    const valorAjuste = resultado.valorAjuste;
    
    // Atualizar info do ajuste
    atualizarInfoAjuste(subtotal, valorAjuste);
    
    // Mostrar breakdown se houver ajuste
    if (ajusteAtual.tipo && ajusteAtual.valor > 0) {
        $('#valor-subtotal').text(`R$ ${subtotal.toFixed(2)}`);
        
        const classAjuste = ajusteAtual.tipo === 'desconto' ? 'desconto' : 'acrescimo';
        const sinalAjuste = ajusteAtual.tipo === 'desconto' ? '-' : '+';
        
        $('#label-ajuste').text(`${ajusteAtual.tipo === 'desconto' ? 'Desconto' : 'Acr√©scimo'}:`);
        $('#valor-ajuste-display')
            .removeClass('desconto acrescimo')
            .addClass(classAjuste)
            .text(`${sinalAjuste} R$ ${valorAjuste.toFixed(2)}`);
        
        $('#row-ajuste').show();
        $('#total-breakdown').show();
    } else {
        $('#total-breakdown').hide();
    }
    
    $('#total-geral').text(`R$ ${total.toFixed(2)}`);
}

// ============================================
// CONTROLES DO CARRINHO
// ============================================

// Aumentar quantidade
$(document).on('click', '.btn-aumentar', function() {
    const id = $(this).data('id');
    const item = carrinho.find(i => i.id === id);
    if (item) {
        // Se for bateria, perguntar sobre casco novamente
        if (item.is_bateria) {
            Swal.fire({
                icon: 'question',
                title: 'Adicionar mais uma bateria?',
                text: 'Para baterias, cada unidade precisa de verifica√ß√£o de casco. Deseja continuar?',
                showCancelButton: true,
                confirmButtonText: 'Sim, mesma condi√ß√£o',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    item.quantidade++;
                    atualizarCarrinho();
                }
            });
            return;
        }
        
        item.quantidade++;
        
        if (item.quantidade > item.estoque && item.estoque > 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Aten√ß√£o!',
                text: `Estoque: ${item.estoque} | Vendendo: ${item.quantidade}`,
                timer: 2000,
                showConfirmButton: false
            });
        }
        
        atualizarCarrinho();
    }
});

// Diminuir quantidade
$(document).on('click', '.btn-diminuir', function() {
    const id = $(this).data('id');
    const item = carrinho.find(i => i.id === id);
    if (item) {
        item.quantidade--;
        if (item.quantidade <= 0) {
            carrinho = carrinho.filter(i => i.id !== id);
        }
        atualizarCarrinho();
    }
});

// Remover item
$(document).on('click', '.btn-remover', function() {
    const id = $(this).data('id');
    carrinho = carrinho.filter(i => i.id !== id);
    atualizarCarrinho();
});

// Limpar carrinho
$('#btn-limpar').on('click', function() {
    if (carrinho.length === 0) return;
    
    Swal.fire({
        title: 'Limpar carrinho?',
        text: 'Todos os itens ser√£o removidos.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, limpar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            carrinho = [];
            
            // Limpar ajuste tamb√©m
            $('#tipo-ajuste').val('');
            $('#valor-ajuste').val('').prop('disabled', true);
            $('#tipo-valor-ajuste').val('reais').prop('disabled', true);
            ajusteAtual = { tipo: '', valor: 0, tipoValor: 'reais' };
            $('#info-ajuste').hide();
            
            atualizarCarrinho();
        }
    });
});

$('#forma-pagamento').on('change', function() {
    const valor = $(this).val();
    const parcelasContainer = document.getElementById('parcelas-container');
    const parcelasCrediarioContainer = document.getElementById('parcelas-crediario-container');
    
    if (valor === 'CP') {
        parcelasContainer.style.display = 'block';
        parcelasCrediarioContainer.style.display = 'none';
    } else if (valor === 'CR') {
        parcelasContainer.style.display = 'none';
        parcelasCrediarioContainer.style.display = 'block';
    } else {
        parcelasContainer.style.display = 'none';
        parcelasCrediarioContainer.style.display = 'none';
    }
    atualizarCarrinho();
});

// Tamb√©m adicionar listener com JavaScript puro (fallback)
document.getElementById('forma-pagamento').addEventListener('change', function() {
    const valor = this.value;
    const parcelasContainer = document.getElementById('parcelas-container');
    const parcelasCrediarioContainer = document.getElementById('parcelas-crediario-container');
    
    if (valor === 'CP') {
        parcelasContainer.style.display = 'block';
        parcelasCrediarioContainer.style.display = 'none';
    } else if (valor === 'CR') {
        parcelasContainer.style.display = 'none';
        parcelasCrediarioContainer.style.display = 'block';
    } else {
        parcelasContainer.style.display = 'none';
        parcelasCrediarioContainer.style.display = 'none';
    }
    atualizarCarrinho();
});

// Atualizar quando mudar n√∫mero de parcelas
$('#numero-parcelas').on('change', function() {
    atualizarCarrinho();
});

// Atualizar quando mudar parcelas do credi√°rio
$('#parcelas-crediario').on('change', function() {
    atualizarCarrinho();
});

// ============================================
// DESCONTO E ACR√âSCIMO
// ============================================

// Habilitar/desabilitar campos de ajuste
$('#tipo-ajuste').on('change', function() {
    const tipo = $(this).val();
    
    if (tipo) {
        $('#valor-ajuste').prop('disabled', false);
        $('#tipo-valor-ajuste').prop('disabled', false);
        ajusteAtual.tipo = tipo;
    } else {
        $('#valor-ajuste').prop('disabled', true).val('');
        $('#tipo-valor-ajuste').prop('disabled', true);
        ajusteAtual.tipo = '';
        ajusteAtual.valor = 0;
        $('#info-ajuste').hide();
    }
    
    atualizarCarrinho();
});

// Atualizar valor do ajuste
$('#valor-ajuste, #tipo-valor-ajuste').on('input change', function() {
    const valor = parseFloat($('#valor-ajuste').val()) || 0;
    const tipoValor = $('#tipo-valor-ajuste').val();
    
    ajusteAtual.valor = valor;
    ajusteAtual.tipoValor = tipoValor;
    
    atualizarCarrinho();
});

function calcularAjuste(subtotal) {
    if (!ajusteAtual.tipo || ajusteAtual.valor <= 0) {
        return { valorAjuste: 0, total: subtotal };
    }
    
    let valorAjuste = 0;
    
    if (ajusteAtual.tipoValor === 'reais') {
        valorAjuste = ajusteAtual.valor;
    } else {
        // Percentual
        valorAjuste = (subtotal * ajusteAtual.valor) / 100;
    }
    
    let total = subtotal;
    
    if (ajusteAtual.tipo === 'desconto') {
        total = subtotal - valorAjuste;
        if (total < 0) total = 0;
    } else {
        total = subtotal + valorAjuste;
    }
    
    return { valorAjuste, total };
}

function atualizarInfoAjuste(subtotal, valorAjuste) {
    const infoEl = $('#info-ajuste');
    const infoTexto = $('#info-ajuste-texto');
    
    if (!ajusteAtual.tipo || ajusteAtual.valor <= 0) {
        infoEl.hide();
        return;
    }
    
    let texto = '';
    
    if (ajusteAtual.tipoValor === 'reais') {
        texto = `R$ ${ajusteAtual.valor.toFixed(2)}`;
    } else {
        texto = `${ajusteAtual.valor}% de R$ ${subtotal.toFixed(2)} = R$ ${valorAjuste.toFixed(2)}`;
    }
    
    if (ajusteAtual.tipo === 'desconto') {
        texto = `Desconto de ${texto}`;
    } else {
        texto = `Acr√©scimo de ${texto}`;
    }
    
    infoTexto.text(texto);
    infoEl.show();
}

// ============================================
// FINALIZAR VENDA
// ============================================
$('#btn-finalizar').on('click', function() {
    const formaPagamento = $('#forma-pagamento').val();
    const clienteId = $('#cliente-select').val();
    
    if (!formaPagamento) {
        Swal.fire({
            icon: 'warning',
            title: 'Aten√ß√£o!',
            text: 'Selecione a forma de pagamento.',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    if (carrinho.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Carrinho vazio!',
            text: 'Adicione produtos antes de finalizar.',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    // Verificar itens sem estoque
    const itensSemEstoque = carrinho.filter(item => item.quantidade > item.estoque);
    let mensagemEstoque = '';
    
    if (itensSemEstoque.length > 0) {
        mensagemEstoque = `<div class="alert alert-warning mt-2">
            <strong>‚ö†Ô∏è Produtos com estoque insuficiente:</strong><br>`;
        itensSemEstoque.forEach(item => {
            mensagemEstoque += `‚Ä¢ ${item.descricao}: Vendendo ${item.quantidade} | Estoque: ${item.estoque}<br>`;
        });
        mensagemEstoque += `<small>O estoque ficar√° negativo.</small></div>`;
    }
    
    const clienteInfo = clienteId ? $('#cliente-select option:selected').text() : 'N√£o informado';
    
    // Calcular subtotal e total com ajuste
    let subtotal = 0;
    const formaPagamentoVal = $('#forma-pagamento').val();
    const numeroParcelas = parseInt($('#numero-parcelas').val()) || 1;
    
    carrinho.forEach(item => {
        let precoFinal = item.preco;
        
        if (formaPagamentoVal === 'DB') {
            precoFinal = item.preco_debito || item.preco;
        } else if (formaPagamentoVal === 'CC') {
            precoFinal = item.preco_credito || item.preco;
        } else if (formaPagamentoVal === 'CP') {
            if (item.preco_customizado && item.precos_credito[numeroParcelas + 'x']) {
                precoFinal = item.precos_credito[numeroParcelas + 'x'];
            } else {
                precoFinal = item.preco_credito || item.preco;
            }
        }
        
        subtotal += precoFinal * item.quantidade;
    });
    
    const resultado = calcularAjuste(subtotal);
    const totalVenda = resultado.total;
    const valorAjuste = resultado.valorAjuste;
    
    const formaPagamentoTexto = $('#forma-pagamento option:selected').text();
    
    let infoAdicional = '';
    if ($('#forma-pagamento').val() === 'CP') {
        const parcelas = $('#numero-parcelas').val();
        const valorParcela = totalVenda / parcelas;
        infoAdicional = `<br><strong>Parcelas:</strong> ${parcelas}x de R$ ${valorParcela.toFixed(2)}`;
    }
    
    // Informa√ß√£o de desconto/acr√©scimo
    let infoAjuste = '';
    if (ajusteAtual.tipo && ajusteAtual.valor > 0) {
        const tipoTexto = ajusteAtual.tipo === 'desconto' ? 'Desconto' : 'Acr√©scimo';
        const sinal = ajusteAtual.tipo === 'desconto' ? '-' : '+';
        infoAjuste = `<br><strong>Subtotal:</strong> R$ ${subtotal.toFixed(2)}<br>
                      <strong>${tipoTexto}:</strong> ${sinal} R$ ${valorAjuste.toFixed(2)}`;
    }
    
    // Info de baterias
    const baterias = carrinho.filter(item => item.is_bateria);
    let infoBaterias = '';
    if (baterias.length > 0) {
        infoBaterias = '<br><strong>üîã Baterias:</strong><br>';
        baterias.forEach(bat => {
            const statusCasco = bat.info_casco.trouxe_casco ? 'Com troca' : 'Sem troca';
            infoBaterias += `‚Ä¢ ${bat.descricao}: ${statusCasco}<br>`;
        });
    }
    
    // Confirma√ß√£o final
    Swal.fire({
        title: 'Confirmar Venda?',
        html: `
            <div style="text-align: left;">
                <strong>Cliente:</strong> ${clienteInfo}<br>
                <strong>Forma de Pagamento:</strong> ${formaPagamentoTexto}${infoAdicional}<br>
                <strong>Total de itens:</strong> ${carrinho.length}${infoAjuste}${infoBaterias}<br>
                <strong>Valor Total:</strong> R$ ${totalVenda.toFixed(2)}
                ${mensagemEstoque}
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Confirmar Venda',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#198754'
    }).then((result) => {
        if (result.isConfirmed) {
            // Preparar dados da venda
            const dadosVenda = {
                cliente_id: clienteId || null,
                forma_pagamento: formaPagamento,
                itens: carrinho.map(item => ({
                    id: item.id,
                    quantidade: item.quantidade,
                    preco: item.preco,
                    total: item.preco * item.quantidade,
                    // Info de bateria
                    is_bateria: item.is_bateria || false,
                    info_casco: item.info_casco || null
                })),
                subtotal: subtotal,
                desconto: ajusteAtual.tipo === 'desconto' ? valorAjuste : 0,
                acrescimo: ajusteAtual.tipo === 'acrescimo' ? valorAjuste : 0,
                total: totalVenda,
                parcelas: formaPagamento === 'CR' ? parseInt($('#parcelas-crediario').val()) || 1 : (formaPagamento === 'CP' ? parseInt($('#numero-parcelas').val()) : 1),
                observacoes: ''
            };

            // Mostrar loading
            Swal.fire({
                title: 'Processando...',
                text: 'Salvando venda',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Enviar para o servidor
            fetch('{% url "api_salvar_venda_pdv" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(dadosVenda)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Venda Realizada!',
                        html: `<strong>${data.numero}</strong><br>Venda registrada com sucesso!`,
                        timer: 3000,
                        showConfirmButton: true,
                        confirmButtonText: 'OK'
                    });

                    // Limpar carrinho
                    carrinho = [];
                    atualizarCarrinho();
                    $('#cliente-select').val('');
                    $('#forma-pagamento').val('DI');
                    $('#parcelas-container').hide();

                    // Limpar ajuste
                    $('#tipo-ajuste').val('');
                    $('#valor-ajuste').val('').prop('disabled', true);
                    $('#tipo-valor-ajuste').val('reais').prop('disabled', true);
                    
                    ajusteAtual = { tipo: '', valor: 0, tipoValor: 'reais' };
                    $('#info-ajuste').hide();
                    
                    $('#search-produto').val('').focus();
                    ultimaBusca = '';
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro!',
                        text: data.error || 'Erro ao salvar venda',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro!',
                    text: 'Erro de conex√£o ao salvar venda',
                    confirmButtonText: 'OK'
                });
            });
        }
    });
});

// ============================================
// ATALHOS DE TECLADO
// ============================================
$(document).on('keydown', function(e) {
    // F2 - Focar em busca
    if (e.key === 'F2') {
        e.preventDefault();
        $('#search-produto').focus().select();
    }
    
    // F3 - Focar em cliente
    if (e.key === 'F3') {
        e.preventDefault();
        $('#cliente-select').focus();
    }
    
    // F4 - Finalizar venda
    if (e.key === 'F4') {
        e.preventDefault();
        $('#btn-finalizar').click();
    }
});

// Focar no campo de busca ao carregar
$(document).ready(function() {
    $('#search-produto').focus();
    carregarAmperagens();
});
</script>

<!-- SweetAlert2 para alertas bonitos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<!-- Modal de Troca de Casco -->
<div class="modal fade" id="modalCasco" tabindex="-1" aria-labelledby="modalCascoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalCascoLabel">
                    <i class="bi bi-battery-charging"></i> Troca de Casco - Bateria
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Info da bateria sendo vendida -->
                <div class="alert alert-info mb-3">
                    <strong>Bateria:</strong> <span id="casco-bateria-nome"></span><br>
                    <strong>Amperagem:</strong> <span id="casco-amperagem-vendida"></span><br>
                    <strong>Valor do Casco:</strong> R$ <span id="casco-valor-vendido">0,00</span>
                </div>
                
                <!-- Pergunta principal -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Cliente trouxe casco para troca?</label>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success flex-fill btn-casco-opcao" data-opcao="sim">
                            <i class="bi bi-check-circle"></i> SIM, trouxe casco
                        </button>
                        <button type="button" class="btn btn-danger flex-fill btn-casco-opcao" data-opcao="nao">
                            <i class="bi bi-x-circle"></i> N√ÉO trouxe
                        </button>
                    </div>
                </div>
                
                <!-- Sele√ß√£o de amperagem do casco (aparece se trouxe) -->
                <div id="casco-amperagem-container" style="display: none;">
                    <label class="form-label fw-bold">Qual a amperagem do casco trazido?</label>
                    <select id="casco-amperagem-select" class="form-select form-select-lg mb-3">
                        <option value="">Selecione a amperagem...</option>
                    </select>
                </div>
                
                <!-- Resultado do c√°lculo -->
                <div id="casco-resultado" class="alert mb-0" style="display: none;">
                    <div id="casco-resultado-texto"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-casco" disabled>
                    <i class="bi bi-check-lg"></i> Confirmar e Adicionar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos do Modal de Casco */
#modalCasco .btn-casco-opcao {
    padding: 15px;
    font-size: 16px;
}

#modalCasco .btn-casco-opcao.active {
    box-shadow: 0 0 0 3px rgba(0,0,0,0.3);
}

#modalCasco .btn-casco-opcao[data-opcao="sim"].active {
    background-color: #146c43 !important;
    border-color: #146c43 !important;
}

#modalCasco .btn-casco-opcao[data-opcao="nao"].active {
    background-color: #b02a37 !important;
    border-color: #b02a37 !important;
}

#casco-resultado.alert-success {
    background-color: #d1e7dd;
    border-color: #badbcc;
    color: #0f5132;
}

#casco-resultado.alert-warning {
    background-color: #fff3cd;
    border-color: #ffecb5;
    color: #664d03;
}

#casco-resultado.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c2c7;
    color: #842029;
}

/* Dark mode */
body.dark-mode #modalCasco .modal-content {
    background-color: #2d2d2d;
    color: #e0e0e0;
}

body.dark-mode #modalCasco .modal-header {
    border-bottom-color: #444;
}

body.dark-mode #modalCasco .modal-footer {
    border-top-color: #444;
}

body.dark-mode #modalCasco .alert-info {
    background-color: #1a3a4a;
    border-color: #2a4a5a;
    color: #7dd3fc;
}

body.dark-mode #modalCasco .form-select {
    background-color: #1a1a1a;
    border-color: #444;
    color: #e0e0e0;
}

/* Badge de bateria no carrinho */
.badge-bateria {
    background-color: #ffc107;
    color: #000;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    margin-left: 5px;
}

.badge-bateria.com-troca {
    background-color: #198754;
    color: white;
}

.badge-bateria.sem-troca {
    background-color: #dc3545;
    color: white;
}
</style>
{% endblock %}